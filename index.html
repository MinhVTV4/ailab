<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Lab - Xác thực & Firestore (Đã cập nhật v11.8.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konva.js -->
    <script src="https://unpkg.com/konva@9.3.6/konva.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        /* Removed conflicting canvas height rule */
        /* #konva-stage-container canvas { max-width: 100%; height: auto !important; } */
        .custom-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 10px 20px; border-radius: 0.375rem; z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
        .custom-toast.show { opacity: 1; }
        .auth-form-container { max-width: 400px; margin: 2rem auto; padding: 2rem; background-color: white; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .lab-hidden { display: none !important; }
        .api-error-notice { background-color: #fff3cd; border-color: #ffeeba; color: #856404; padding: .75rem 1.25rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: .25rem; }
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 40; display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); width: 90%; max-width: 500px; }
        .info-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            width: 90%;
            max-width: 450px;
        }
        .info-panel-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.4);
            z-index: 49;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .info-panel.show, .info-panel-overlay.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .info-panel-overlay.show {
             opacity: 1;
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Khu vực Xác thực -->
    <div id="auth-container" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md mb-4 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-md">
            <p class="font-bold">Lưu ý quan trọng:</p>
            <p>1. Để sử dụng chức năng đăng nhập/đăng ký bằng Email, bạn cần kích hoạt phương thức "Email/Password" trong Firebase Console -> Authentication -> Sign-in method.</p>
            <p class="mt-2">2. Để chức năng "Tạo Hóa Chất" hoạt động, hãy đảm bảo API Key của Google Cloud (dùng cho Gemini API) đã được cấu hình đúng và dịch vụ "Generative Language API" (hoặc Vertex AI) đã được bật cho dự án của bạn.</p>
             <p class="mt-2">App ID: <span id="app-id-display">Đang tải...</span></p>
             <p class="mt-1">User ID: <span id="user-id-display-auth">Chưa đăng nhập</span></p>
        </div>
        <div id="user-status" class="w-full max-w-md mb-4 p-3 bg-white rounded-lg shadow text-center">
            <p id="user-email-display">Chưa đăng nhập</p>
            <button id="signOutButton" class="hidden mt-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md text-sm">Đăng xuất</button>
        </div>

        <div id="login-form-container" class="auth-form-container">
            <h2 class="text-2xl font-bold text-blue-700 text-center mb-6">Đăng Nhập</h2>
            <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 mb-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
            <input type="password" id="loginPassword" placeholder="Mật khẩu" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
            <button id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded-md mb-2 transition-colors">Đăng Nhập</button>
            <p class="text-center text-sm">Chưa có tài khoản? <a href="#" id="showRegisterLink" class="text-blue-600 hover:underline">Đăng ký ngay</a></p>
        </div>

        <div id="register-form-container" class="auth-form-container hidden">
            <h2 class="text-2xl font-bold text-green-700 text-center mb-6">Đăng Ký</h2>
            <input type="email" id="registerEmail" placeholder="Email" class="w-full p-3 mb-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none">
            <input type="password" id="registerPassword" placeholder="Mật khẩu (ít nhất 6 ký tự)" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none">
            <button id="registerButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-md mb-2 transition-colors">Đăng Ký</button>
            <p class="text-center text-sm">Đã có tài khoản? <a href="#" id="showLoginLink" class="text-green-600 hover:underline">Đăng nhập</a></p>
        </div>
    </div>

    <!-- Khu vực Phòng Thí Nghiệm (ban đầu bị ẩn) -->
    <div id="lab-section" class="lab-hidden p-4 md:p-8">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-700">Phòng Thí Nghiệm Mô Phỏng AI</h1>
            <div>
                 <p class="text-sm text-gray-600">App ID: <span id="app-id-display-lab"></span></p>
                 <p class="text-sm text-gray-600">User ID: <span id="user-id-display-lab"></span></p>
            </div>
        </div>
        
        <div class="mb-6 p-4 bg-white rounded-lg shadow">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Tạo Hóa Chất Mới (AI Hỗ Trợ)</h3>
            <div id="gemini-api-error-notice" class="api-error-notice hidden">
                <p class="font-bold">Lỗi kết nối Gemini API!</p>
                <p>Không thể tạo hóa chất. Vui lòng kiểm tra cấu hình API Key và đảm bảo dịch vụ Generative Language API đã được bật trên Google Cloud Console.</p>
            </div>
            <div class="flex gap-2 flex-col sm:flex-row">
                <input type="text" id="chemicalNameInput" placeholder="Nhập tên hóa chất (ví dụ: Axit Sunfuric)" class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none">
                <button id="createChemicalButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-md transition-colors">Tạo Hóa Chất</button>
            </div>
            <div id="aiChemicalDefinitionArea" class="mt-4 p-3 border rounded-md bg-gray-50 min-h-[100px] whitespace-pre-line">
                Thông tin hóa chất từ AI sẽ hiển thị ở đây...
            </div>
        </div>
        
        <div class="mb-6 p-4 bg-white rounded-lg shadow">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Hóa Chất Của Bạn</h3>
            <div id="userChemicalsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 min-h-[100px] bg-gray-50 p-3 rounded-md border">
                <p class="text-gray-500 col-span-full text-center py-4">Chưa có hóa chất nào được lưu.</p>
            </div>
        </div>

        <div id="lab-container" class="flex flex-col md:flex-row md:justify-around w-full max-w-7xl mx-auto gap-4">
            <div id="konva-outer-container" class="w-full md:w-2/3 bg-gray-200 border border-gray-300 rounded-lg shadow p-2 flex justify-center items-center touch-none overflow-hidden"> 
                <div id="konva-stage-container"></div>
            </div>

            <div id="ai-controls-container" class="w-full md:w-1/3 flex flex-col bg-white p-4 border border-gray-300 rounded-lg shadow">
                <h2 class="text-xl font-semibold text-blue-600 mb-3">Kết quả & Tương tác AI</h2>
                <h3 class="text-lg font-semibold text-blue-600 mb-2">Phản hồi từ Gemini:</h3>
                <div id="responseContainer" class="p-3 border border-gray-200 bg-gray-50 rounded-md min-h-[150px] whitespace-pre-wrap flex-grow overflow-y-auto mb-4 text-sm">
                    Chưa có phản hồi...
                </div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Gửi lời nhắc thủ công:</h3>
                <div id="controls" class="flex flex-col">
                    <textarea id="promptInput" rows="3" placeholder="Nhập lời nhắc thủ công ở đây..." class="w-full p-2.5 border border-gray-300 rounded-md mb-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm"></textarea>
                    <button id="sendPromptButtonLab" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded-md mb-2 transition-colors">Gửi tới Gemini (Thí nghiệm)</button>
                </div>
                <button id="resetBeakerButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-4 rounded-md transition duration-150 mt-4">Làm sạch cốc</button>
            </div>
        </div>
    </div>
    <div id="customToast" class="custom-toast"></div>

    <!-- Modal xác nhận lưu hóa chất -->
    <div id="confirmSaveModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Xác nhận Lưu Hóa Chất</h3>
            <div id="confirmChemicalDetails" class="mb-4 text-xs max-h-60 overflow-y-auto bg-gray-100 p-2 rounded-md">
                {/* Chi tiết hóa chất từ AI sẽ được chèn vào đây */}
            </div>
            <p class="mb-4">Bạn có muốn lưu hóa chất này vào kho lưu trữ cá nhân không?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelSaveChemical" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md transition-colors">Hủy</button>
                <button id="confirmSaveChemicalButtonAction" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Lưu</button>
            </div>
        </div>
    </div>

    <!-- Modal xác nhận xóa hóa chất -->
    <div id="confirmDeleteModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Xác nhận Xóa</h3>
            <p id="confirmDeleteMessage" class="mb-4">Bạn có chắc muốn xóa mục này không?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDeleteButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md transition-colors">Hủy</button>
                <button id="confirmDeleteButtonAction" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Xóa</button>
            </div>
        </div>
    </div>
    
    <!-- Info Panel for Chemical Details (click on Konva object) -->
    <div id="info-panel-overlay" class="info-panel-overlay hidden"></div>
    <div id="info-panel" class="info-panel hidden">
        <button id="info-panel-close-x" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-700">&times;</button>
        <h3 id="info-panel-title" class="text-xl font-bold mb-3 text-blue-700">Thông tin Hóa chất</h3>
        <div id="info-panel-description" class="text-sm text-gray-700 max-h-60 overflow-y-auto whitespace-pre-line">
            Mô tả chi tiết sẽ hiển thị ở đây...
        </div>
        <button id="info-panel-close-button" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md w-full transition-colors">Đóng</button>
    </div>


    <script type="module">
        // Import các hàm từ Firebase SDK - **PHIÊN BẢN ĐÃ CẬP NHẬT LÊN 11.8.1**
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence,
            signInAnonymously, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            getDocs,
            onSnapshot, 
            serverTimestamp,
            deleteDoc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // Firebase Configuration - Use __firebase_config if available
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        let firebaseConfig;
        if (firebaseConfigString) {
            try {
                firebaseConfig = JSON.parse(firebaseConfigString);
            } catch (e) {
                console.error("Failed to parse __firebase_config:", e);
                // Fallback or error display if __firebase_config is malformed
                showToast("Lỗi cấu hình Firebase. Vui lòng thử lại.");
                firebaseConfig = { apiKey: "FALLBACK_KEY_IF_NEEDED", authDomain: "", projectId: "" }; // Minimal fallback
            }
        } else {
             // Fallback to a default/placeholder if __firebase_config is not provided at all
            console.warn("__firebase_config not found. Using placeholder config. App may not fully function.");
            showToast("Cấu hình Firebase không tìm thấy. Một số chức năng có thể không hoạt động.");
            firebaseConfig = {
                 // DO NOT use this in production if __firebase_config is meant to be the source
                apiKey: "YOUR_FALLBACK_API_KEY", // Replace if you have one for local dev outside Canvas
                authDomain: "your-fallback-project-id.firebaseapp.com",
                projectId: "your-fallback-project-id",
                // Add other necessary fallback config fields
            };
        }
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); // For more detailed Firestore logs in console
        console.log("Firebase App, Auth, and Firestore initialized (v11.8.1)!");

        const GEMINI_API_KEY = ""; // This should be empty string, Canvas will provide it.
        const GEMINI_API_URL_FLASH = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-ai-lab-app';
        let currentUserId = null; 
        let currentSelectedAiChemical = null; 
        let chemicalToDeleteId = null; // For delete confirmation modal

        // DOM Elements
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const authContainer = document.getElementById('auth-container');
        const labSection = document.getElementById('lab-section');
        const userEmailDisplay = document.getElementById('user-email-display');
        const signOutButton = document.getElementById('signOutButton');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const registerButton = document.getElementById('registerButton');
        const showRegisterLink = document.getElementById('showRegisterLink');
        const showLoginLink = document.getElementById('showLoginLink');
        const chemicalNameInput = document.getElementById('chemicalNameInput');
        const createChemicalButton = document.getElementById('createChemicalButton');
        const aiChemicalDefinitionArea = document.getElementById('aiChemicalDefinitionArea');
        const userChemicalsContainer = document.getElementById('userChemicalsContainer');
        
        const confirmSaveModal = document.getElementById('confirmSaveModal');
        const confirmChemicalDetails = document.getElementById('confirmChemicalDetails');
        const cancelSaveChemical = document.getElementById('cancelSaveChemical');
        const confirmSaveChemicalButtonAction = document.getElementById('confirmSaveChemicalButtonAction');
        
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const confirmDeleteMessage = document.getElementById('confirmDeleteMessage');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const confirmDeleteButtonAction = document.getElementById('confirmDeleteButtonAction');

        const geminiApiErrorNotice = document.getElementById('gemini-api-error-notice');

        const infoPanel = document.getElementById('info-panel');
        const infoPanelOverlay = document.getElementById('info-panel-overlay');
        const infoPanelTitle = document.getElementById('info-panel-title');
        const infoPanelDescription = document.getElementById('info-panel-description');
        const infoPanelCloseButton = document.getElementById('info-panel-close-button');
        const infoPanelCloseX = document.getElementById('info-panel-close-x');

        const appIdDisplay = document.getElementById('app-id-display');
        const userIdDisplayAuth = document.getElementById('user-id-display-auth');
        const appIdDisplayLab = document.getElementById('app-id-display-lab');
        const userIdDisplayLab = document.getElementById('user-id-display-lab');


        if(appIdDisplay) appIdDisplay.textContent = appId;
        if(appIdDisplayLab) appIdDisplayLab.textContent = appId;


        function showToast(message) {
            const toast = document.getElementById('customToast');
            if (toast) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000); 
            } else {
                console.warn("Custom toast element not found. Message:", message);
            }
        }
        
        function showDeleteConfirmModal(chemicalName, idToDelete) {
            chemicalToDeleteId = idToDelete;
            confirmDeleteMessage.textContent = `Bạn có chắc muốn xóa hóa chất "${chemicalName || 'này'}" không?`;
            confirmDeleteModal.classList.remove('hidden');
        }

        confirmDeleteButtonAction.addEventListener('click', async () => {
            if (chemicalToDeleteId && currentUserId) {
                try {
                    await deleteDoc(doc(db, "artifacts", appId, "users", currentUserId, "customChemicals", chemicalToDeleteId));
                    showToast("Đã xóa hóa chất.");
                    chemicalToDeleteId = null; 
                } catch (error) {
                    console.error("Lỗi khi xóa hóa chất:", error);
                    showToast(`Lỗi xóa: ${error.message}`);
                }
            }
            confirmDeleteModal.classList.add('hidden');
        });

        cancelDeleteButton.addEventListener('click', () => {
            confirmDeleteModal.classList.add('hidden');
            chemicalToDeleteId = null;
        });


        async function callGeminiAPI(promptText, targetElementId = "responseContainer") {
            const responseContainer = document.getElementById(targetElementId); 
            
            if (!promptText || !promptText.trim()) {
                showToast("Vui lòng nhập lời nhắc cho Gemini.");
                return null; 
            }

            if (responseContainer) {
                responseContainer.textContent = "Đang gửi yêu cầu đến Gemini...";
            }
            console.log("Calling generic Gemini API with prompt:", promptText);

            try {
                const payload = { contents: [{ role: "user", parts: [{ text: promptText }] }] };
                const response = await fetch(GEMINI_API_URL_FLASH, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) { 
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    console.error("Gemini API request failed with status:", response.status, errorData);
                    throw new Error(`Lỗi API Gemini: ${response.status} ${errorData.error ? errorData.error.message : errorData.message}`);
                }
                const result = await response.json();

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (responseContainer && targetElementId === "responseContainer") { 
                        responseContainer.innerHTML = `<strong>Phản hồi từ AI:</strong><br>${text}`;
                    }
                    console.log("Response text from generic Gemini API:", text);
                    return text; 
                } else {
                    throw new Error("AI không trả về phản hồi hợp lệ cho prompt.");
                }
            } catch (error) {
                console.error("Lỗi khi gọi Gemini API (chung):", error);
                if (responseContainer) {
                    responseContainer.innerHTML = `<span class="text-red-600 font-bold">Lỗi Gemini: ${error.message}.</span>`;
                }
                return null; 
            }
        }

        function displayChemicalInfoInPanel(chemicalData) {
            if (chemicalData && infoPanel && infoPanelTitle && infoPanelDescription && infoPanelOverlay) {
                infoPanelTitle.textContent = chemicalData.name || "Thông tin Hóa chất";
                
                let descriptionHtml = `<strong>Công thức:</strong> ${chemicalData.formula || 'N/A'}<br>`;
                descriptionHtml += `<strong>Hình dạng:</strong> ${chemicalData.appearance || 'N/A'}<br>`;
                if(chemicalData.density_g_cm3) descriptionHtml += `<strong>Khối lượng riêng:</strong> ${chemicalData.density_g_cm3} g/cm³<br>`;
                if(chemicalData.boiling_point_C) descriptionHtml += `<strong>Nhiệt độ sôi:</strong> ${chemicalData.boiling_point_C} °C<br>`;
                if(chemicalData.melting_point_C) descriptionHtml += `<strong>Nhiệt độ nóng chảy:</strong> ${chemicalData.melting_point_C} °C<br>`;
                descriptionHtml += `<strong>Mô tả:</strong> ${chemicalData.description || "Không có mô tả chi tiết."}`;

                infoPanelDescription.innerHTML = descriptionHtml;
                infoPanel.classList.remove('hidden');
                infoPanel.classList.add('show');
                infoPanelOverlay.classList.remove('hidden');
                infoPanelOverlay.classList.add('show');
            } else {
                console.warn("Could not display info panel. Data or panel elements missing.");
                showToast("Không thể hiển thị thông tin chi tiết.");
            }
        }

        function hideInfoPanel() {
            if (infoPanel && infoPanelOverlay) {
                infoPanel.classList.remove('show');
                infoPanelOverlay.classList.remove('show');
                setTimeout(() => {
                    infoPanel.classList.add('hidden');
                    infoPanelOverlay.classList.add('hidden');
                }, 300); 
            }
        }
        if (infoPanelCloseButton) infoPanelCloseButton.addEventListener('click', hideInfoPanel);
        if (infoPanelCloseX) infoPanelCloseX.addEventListener('click', hideInfoPanel);
        if (infoPanelOverlay) infoPanelOverlay.addEventListener('click', hideInfoPanel);


        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginFormContainer.classList.add('hidden');
            registerFormContainer.classList.remove('hidden');
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerFormContainer.classList.add('hidden');
            loginFormContainer.classList.remove('hidden');
        });
        
        async function attemptSignIn() {
            try {
                await setPersistence(auth, browserLocalPersistence);
                console.log("Firebase Auth persistence set to local.");

                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    console.log("Attempting sign in with custom token.");
                    await signInWithCustomToken(auth, token);
                    console.log("Successfully signed in with custom token.");
                } else {
                    console.log("__initial_auth_token not found. Will rely on onAuthStateChanged or attempt anonymous sign-in if no user is found.");
                }
            } catch (error) {
                console.error("Error during initial sign-in attempt or persistence setting:", error);
                showToast(`Lỗi khởi tạo xác thực: ${error.message}`);
                if (error.code === 'auth/invalid-custom-token' && !auth.currentUser) {
                    try {
                        console.warn("Custom token failed, attempting anonymous sign-in.");
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously after custom token failure.");
                    } catch (anonError) {
                        console.error("Anonymous sign-in also failed:", anonError);
                        showToast(`Lỗi đăng nhập ẩn danh: ${anonError.message}`);
                    }
                }
            }
        }
        
        attemptSignIn(); 

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("User logged in:", currentUserId, user.email);
                const displayEmail = user.isAnonymous ? "Người dùng ẩn danh" : user.email;
                userEmailDisplay.textContent = `Đã đăng nhập với: ${displayEmail}`;
                if(userIdDisplayAuth) userIdDisplayAuth.textContent = currentUserId;
                if(userIdDisplayLab) userIdDisplayLab.textContent = currentUserId;

                signOutButton.classList.remove('hidden');
                authContainer.classList.add('lab-hidden'); 
                labSection.classList.remove('lab-hidden'); 
                
                if (!konvaStage) { 
                    initializeLabKonva();
                }
                loadUserChemicals();

            } else {
                currentUserId = null;
                console.log("User logged out or not logged in.");
                userEmailDisplay.textContent = "Chưa đăng nhập";
                 if(userIdDisplayAuth) userIdDisplayAuth.textContent = "Chưa đăng nhập";
                if(userIdDisplayLab) userIdDisplayLab.textContent = "Chưa đăng nhập";
                signOutButton.classList.add('hidden');
                authContainer.classList.remove('lab-hidden'); 
                labSection.classList.add('lab-hidden');     
                clearLabOnLogout();
            }
        });

        loginButton.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) {
                showToast("Vui lòng nhập email và mật khẩu.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("Đăng nhập thành công!");
                loginEmailInput.value = '';
                loginPasswordInput.value = '';
            } catch (error) {
                console.error("Lỗi đăng nhập:", error);
                showToast(`Lỗi đăng nhập: ${error.message}`);
            }
        });

        registerButton.addEventListener('click', async () => {
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            if (!email || !password) {
                showToast("Vui lòng nhập email và mật khẩu.");
                return;
            }
            if (password.length < 6) {
                showToast("Mật khẩu phải có ít nhất 6 ký tự.");
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast("Đăng ký thành công! Đang chuyển đến đăng nhập...");
                registerEmailInput.value = '';
                registerPasswordInput.value = '';
                registerFormContainer.classList.add('hidden');
                loginFormContainer.classList.remove('hidden');
            } catch (error) {
                console.error("Lỗi đăng ký:", error);
                showToast(`Lỗi đăng ký: ${error.message}. Hãy đảm bảo phương thức Email/Password đã được bật trong Firebase Console.`);
            }
        });

        signOutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast("Đã đăng xuất.");
            } catch (error) {
                console.error("Lỗi đăng xuất:", error);
                showToast(`Lỗi đăng xuất: ${error.message}`);
            }
        });
        
        createChemicalButton.addEventListener('click', async () => {
            if (!currentUserId) {
                showToast("Vui lòng đăng nhập để tạo hóa chất.");
                return;
            }
            const chemicalName = chemicalNameInput.value.trim();
            if (!chemicalName) {
                showToast("Vui lòng nhập tên hóa chất.");
                return;
            }
            aiChemicalDefinitionArea.textContent = "Đang liên hệ với AI để định nghĩa hóa chất...";
            geminiApiErrorNotice.classList.add('hidden'); 
            currentSelectedAiChemical = null;
            const prompt = `Cung cấp thông tin chi tiết về hóa chất "${chemicalName}" dưới dạng một đối tượng JSON. JSON object phải bao gồm các trường sau:
- "name": (string) Tên đầy đủ và phổ biến của hóa chất.
- "formula": (string) Công thức hóa học.
- "appearance": (string) Mô tả ngắn về hình dạng, trạng thái ở điều kiện thường (ví dụ: chất lỏng không màu, chất rắn tinh thể màu trắng).
- "solutionColor": (string) Một chuỗi RGBA đại diện cho màu sắc của dung dịch hóa chất khi hòa tan trong nước (nếu có thể). Ví dụ: "rgba(255, 100, 100, 0.6)" cho màu hồng nhạt, hoặc "rgba(255, 255, 255, 0.1)" nếu không màu/rất nhạt. Nếu là chất rắn không tan, có thể để "rgba(200,200,200,0.7)".
- "description": (string) Mô tả chi tiết hơn về tính chất vật lý, hóa học cơ bản, ứng dụng hoặc cảnh báo an toàn (nếu có).
- "density_g_cm3": (number, optional) Khối lượng riêng (g/cm³) nếu có.
- "boiling_point_C": (number or string, optional) Nhiệt độ sôi (°C) nếu có.
- "melting_point_C": (number or string, optional) Nhiệt độ nóng chảy (°C) nếu có.
- "isFlammable": (boolean, optional) Có dễ cháy không.
- "isReactive": (boolean, optional) Có dễ phản ứng không.
- "specificReactions": (array of objects, optional) Một mảng các phản ứng đặc trưng, mỗi object có dạng {"with": "tên_chất_khác", "phenomenon": "mô_tả_hiện_tượng_trực_quan", "product": "sản_phẩm_chính"}. Chỉ bao gồm 1-2 phản ứng quan trọng nhất.

Hãy đảm bảo output CHỈ LÀ JSON object đó, không có bất kỳ văn bản giải thích nào khác xung quanh JSON. Ví dụ cho HCl:
{
  "name": "Axit Clohydric",
  "formula": "HCl",
  "appearance": "Chất lỏng không màu, bốc khói trong không khí ẩm.",
  "solutionColor": "rgba(255, 255, 255, 0.1)",
  "description": "Là một axit mạnh, ăn mòn nhiều kim loại. Được sử dụng rộng rãi trong công nghiệp và phòng thí nghiệm.",
  "density_g_cm3": 1.18,
  "boiling_point_C": "Khoảng -85 (khan) đến 110 (dung dịch 20.2%)",
  "isReactive": true,
  "specificReactions": [
    {"with": "NaOH", "phenomenon": "Phản ứng trung hòa, tỏa nhiệt, có thể có sủi bọt nhẹ.", "product": "NaCl, H2O"},
    {"with": "AgNO3", "phenomenon": "Tạo kết tủa trắng AgCl.", "product": "AgCl"}
  ]
}
`;
            const rawJsonText = await callGeminiAPI(prompt, null); 

            if (rawJsonText) {
                try {
                    const cleanedJsonText = rawJsonText.replace(/^```json\s*([\s\S]*?)\s*```$/, '$1').trim();
                    console.log("Raw JSON text from AI for chemical definition:", cleanedJsonText);
                    currentSelectedAiChemical = JSON.parse(cleanedJsonText); 
                    confirmChemicalDetails.innerHTML = `<pre class="bg-gray-100 p-2 rounded text-xs">${JSON.stringify(currentSelectedAiChemical, null, 2)}</pre>`;
                    confirmSaveModal.classList.remove('hidden');
                    aiChemicalDefinitionArea.textContent = `AI đã định nghĩa hóa chất: ${currentSelectedAiChemical.name || chemicalName}. Kiểm tra và xác nhận lưu.`;
                } catch (parseError) {
                    console.error("Lỗi khi parse JSON từ AI:", parseError, "Raw text:", rawJsonText);
                    aiChemicalDefinitionArea.textContent = `Lỗi: Không thể phân tích định nghĩa hóa chất từ AI. Chi tiết: ${parseError.message}`;
                    geminiApiErrorNotice.classList.remove('hidden'); 
                    currentSelectedAiChemical = null;
                }
            } else {
                aiChemicalDefinitionArea.textContent = "Lỗi: Không nhận được phản hồi hợp lệ từ AI.";
                geminiApiErrorNotice.classList.remove('hidden');
                currentSelectedAiChemical = null;
            }
        });

        cancelSaveChemical.addEventListener('click', () => {
            confirmSaveModal.classList.add('hidden');
            currentSelectedAiChemical = null; 
            aiChemicalDefinitionArea.textContent = "Đã hủy lưu hóa chất.";
        });
        
        confirmSaveChemicalButtonAction.addEventListener('click', async () => {
            if (!currentSelectedAiChemical || !currentUserId) {
                showToast("Không có thông tin hóa chất để lưu hoặc bạn chưa đăng nhập.");
                confirmSaveModal.classList.add('hidden');
                return;
            }
            try {
                const chemicalToSave = {
                    ...currentSelectedAiChemical,
                    userId: currentUserId, 
                    createdAt: serverTimestamp() 
                };
                const chemicalCollectionRef = collection(db, "artifacts", appId, "users", currentUserId, "customChemicals");
                const docRef = await addDoc(chemicalCollectionRef, chemicalToSave);
                console.log("Hóa chất đã được lưu với ID: ", docRef.id);
                showToast(`Đã lưu hóa chất: ${currentSelectedAiChemical.name || 'Chưa có tên'}`);
                chemicalNameInput.value = ''; 
                aiChemicalDefinitionArea.textContent = "Thông tin hóa chất từ AI sẽ hiển thị ở đây...";
                currentSelectedAiChemical = null; 
                confirmSaveModal.classList.add('hidden');
            } catch (error) {
                console.error("Lỗi khi lưu hóa chất vào Firestore:", error);
                showToast(`Lỗi khi lưu hóa chất: ${error.message}`);
            }
        });

        let unsubscribeUserChemicals = null; 

        async function loadUserChemicals() {
            if (!currentUserId) {
                console.warn("[loadUserChemicals] No currentUserId, skipping load.");
                return;
            }
             if (!db) { 
                console.error("[loadUserChemicals] Firestore db instance is not available.");
                showToast("Lỗi kết nối cơ sở dữ liệu.");
                return;
            }
            console.log(`[loadUserChemicals] Loading chemicals for user: ${currentUserId} and appId: ${appId}`);
            
            if (unsubscribeUserChemicals) {
                unsubscribeUserChemicals();
                console.log("[loadUserChemicals] Unsubscribed from previous chemical listener.");
            }
            
            const chemicalsRef = collection(db, "artifacts", appId, "users", currentUserId, "customChemicals");
            console.log("[loadUserChemicals] Firestore collection path:", chemicalsRef.path);

            unsubscribeUserChemicals = onSnapshot(chemicalsRef, (querySnapshot) => {
                console.log(`[onSnapshot] Received ${querySnapshot.docs.length} chemical documents for user ${currentUserId}.`);
                userChemicalsContainer.innerHTML = ''; 
                if (querySnapshot.empty) {
                    userChemicalsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">Bạn chưa lưu hóa chất nào.</p>';
                    console.log("[onSnapshot] No chemicals found for this user.");
                    return;
                }
                querySnapshot.forEach((docSnap) => {
                    const chemicalData = docSnap.data();
                    const chemicalId = docSnap.id;
                    console.log(`[onSnapshot] Processing chemical: ${chemicalData.name} (ID: ${chemicalId})`);
                    
                    const chemicalElement = document.createElement('div');
                    chemicalElement.className = 'p-3 bg-white border rounded-lg shadow-sm cursor-pointer hover:shadow-lg transition-all duration-200 ease-in-out transform hover:-translate-y-1';
                    chemicalElement.setAttribute('data-chemical-id', chemicalId);
                    
                    const bgColor = chemicalData.solutionColor || 'rgba(229, 231, 235, 0.7)'; 
                    chemicalElement.style.backgroundColor = bgColor.replace(/[\d\.]+\)$/g, '0.3)'); 
                    chemicalElement.style.borderColor = bgColor.replace(/[\d\.]+\)$/g, '1)'); 
                    
                    const nameEl = document.createElement('h4');
                    nameEl.className = 'font-semibold text-sm mb-1 truncate text-gray-800';
                    nameEl.textContent = chemicalData.name || "Chưa đặt tên";
                    chemicalElement.appendChild(nameEl);
                    
                    const formulaEl = document.createElement('p');
                    formulaEl.className = 'text-xs text-gray-600 mb-2 truncate';
                    formulaEl.textContent = `(${chemicalData.formula || 'N/A'})`;
                    chemicalElement.appendChild(formulaEl);
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '&times;'; 
                    deleteButton.className = 'absolute top-1.5 right-1.5 text-xs bg-red-200 hover:bg-red-400 text-red-700 hover:text-white rounded-full w-5 h-5 flex items-center justify-center focus:outline-none transition-colors';
                    deleteButton.title = "Xóa hóa chất này";
                    deleteButton.style.lineHeight = '1'; 
                    chemicalElement.style.position = 'relative'; 
                    
                    deleteButton.onclick = (e) => {
                        e.stopPropagation(); 
                        showDeleteConfirmModal(chemicalData.name, chemicalId);
                    };
                    chemicalElement.appendChild(deleteButton);
                    
                    chemicalElement.addEventListener('click', () => {
                        console.log("Clicked on saved chemical:", chemicalData);
                        addKonvaChemicalFromData(chemicalData, chemicalId);
                    });
                    userChemicalsContainer.appendChild(chemicalElement);
                });
            }, (error) => {
                console.error(`Lỗi khi lắng nghe thay đổi hóa chất cho user ${currentUserId}:`, error);
                userChemicalsContainer.innerHTML = '<p class="text-red-500 col-span-full text-center py-4">Lỗi tải danh sách hóa chất.</p>';
            });
        }
        
        function clearLabOnLogout() {
            console.log("[clearLabOnLogout] Clearing lab data.");
            if (unsubscribeUserChemicals) {
                unsubscribeUserChemicals(); 
                unsubscribeUserChemicals = null;
                console.log("[clearLabOnLogout] Unsubscribed from chemical listener.");
            }
            if (userChemicalsContainer) { 
                userChemicalsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">Vui lòng đăng nhập để xem hóa chất.</p>';
            }
            if (konvaStage) { 
                if(konvaLayer) konvaLayer.find('.dynamic-chemical').forEach(node => node.destroy()); 
                if(konvaEffectsLayer) konvaEffectsLayer.find('.bubble, .smoke, .precipitate').forEach(node => node.destroy()); 
                konvaChemicalsInBeaker = []; 
                updateKonvaSolutionVisualState(); 
                if(konvaLayer) konvaLayer.batchDraw(); 
                if(konvaEffectsLayer) konvaEffectsLayer.batchDraw(); 
                console.log("[clearLabOnLogout] Konva stage cleared.");
            }
            currentSelectedAiChemical = null;
            if(aiChemicalDefinitionArea) aiChemicalDefinitionArea.textContent = "Thông tin hóa chất từ AI sẽ hiển thị ở đây...";
            if(geminiApiErrorNotice) geminiApiErrorNotice.classList.add('hidden');
            if(document.getElementById('responseContainer')) document.getElementById('responseContainer').textContent = "Chưa có phản hồi...";

        }

        let konvaStage, konvaLayer, konvaEffectsLayer; 
        let konvaBeaker, konvaSolution, konvaBeakerLabel;
        let konvaChemicalsInBeaker = []; 
        let konvaBubbleAnimation, konvaSmokeAnimation, konvaPrecipitateAnimation;

        const KONVA_INITIAL_STAGE_WIDTH = 600; 
        const KONVA_INITIAL_STAGE_HEIGHT = 400; 
        const KONVA_BEAKER_BASE_SIZE = { width: 150, height: 180 }; 
        const KONVA_MAX_LIQUID_RISE_RATIO = 0.7; 
        const KONVA_SOLUTION_PADDING_RATIO = 0.05; 


        function initializeLabKonva() {
            console.log("[initializeLabKonva] Initializing Konva stage and objects.");
            if (konvaStage) { 
                fitKonvaStageToParent(); 
                konvaStage.batchDraw();
                return;
            }
            const konvaOuterEl = document.getElementById('konva-outer-container');
            if (!konvaOuterEl) {
                console.error("Konva outer container not found!");
                return;
            }
            let currentW = konvaOuterEl.clientWidth > 20 ? konvaOuterEl.clientWidth - 16 : KONVA_INITIAL_STAGE_WIDTH; 
            let currentH = (currentW / KONVA_INITIAL_STAGE_WIDTH) * KONVA_INITIAL_STAGE_HEIGHT; 

            konvaStage = new Konva.Stage({
                container: 'konva-stage-container', 
                width: currentW,
                height: currentH,
            });
            konvaLayer = new Konva.Layer();
            konvaStage.add(konvaLayer);
            konvaEffectsLayer = new Konva.Layer(); 
            konvaStage.add(konvaEffectsLayer);
            
            const beakerWidth = (KONVA_BEAKER_BASE_SIZE.width / KONVA_INITIAL_STAGE_WIDTH) * currentW;
            const beakerHeight = (KONVA_BEAKER_BASE_SIZE.height / KONVA_INITIAL_STAGE_HEIGHT) * currentH;
            const beakerX = currentW / 2 - beakerWidth / 2;
            const beakerY = currentH - beakerHeight - (0.05 * currentH); 

            konvaBeaker = new Konva.Rect({
                x: beakerX,
                y: beakerY,
                width: beakerWidth,
                height: beakerHeight,
                fill: 'rgba(220, 220, 240, 0.4)', 
                stroke: 'rgba(100, 100, 120, 0.8)', 
                strokeWidth: Math.max(1, (2 / KONVA_INITIAL_STAGE_WIDTH) * currentW), 
                name: 'beaker',
                cornerRadius: [0, 0, beakerWidth * 0.1, beakerWidth * 0.1] 
            });
            konvaLayer.add(konvaBeaker);
            
            konvaSolution = new Konva.Rect({
                fill: 'rgba(173, 216, 230, 0.3)', 
                name: 'solution',
                visible: false 
            });
            konvaLayer.add(konvaSolution); 
            konvaBeaker.moveToTop(); 

            const labelFontSize = Math.max(10, (16 / KONVA_INITIAL_STAGE_WIDTH) * currentW); 
            konvaBeakerLabel = new Konva.Text({
                text: 'Cốc Thí Nghiệm',
                fontSize: labelFontSize,
                fill: 'rgba(50, 50, 70, 0.9)',
                fontFamily: 'Inter, sans-serif',
            });
            konvaLayer.add(konvaBeakerLabel);
            
            updateKonvaBeakerLabelPosition();
            updateKonvaSolutionVisualState(); 
            
            window.addEventListener('resize', fitKonvaStageToParent);
            fitKonvaStageToParent(); 
            console.log("[initializeLabKonva] Konva initialized and fitted.");
        }
        
        function fitKonvaStageToParent() {
            const container = document.getElementById('konva-outer-container');
            if (!container || !konvaStage) return;

            let containerWidth = container.offsetWidth;
            const computedStyle = getComputedStyle(container);
            const paddingLeft = parseFloat(computedStyle.paddingLeft) || 0;
            const paddingRight = parseFloat(computedStyle.paddingRight) || 0;
            containerWidth = containerWidth - paddingLeft - paddingRight;
            
            if (containerWidth <= 0) containerWidth = KONVA_INITIAL_STAGE_WIDTH; 

            const scaleRatio = containerWidth / KONVA_INITIAL_STAGE_WIDTH;
            const newStageWidth = containerWidth;
            const newStageHeight = KONVA_INITIAL_STAGE_HEIGHT * scaleRatio;

            konvaStage.width(newStageWidth);
            konvaStage.height(newStageHeight);

            if (konvaBeaker) {
                const newBeakerWidth = KONVA_BEAKER_BASE_SIZE.width * scaleRatio;
                const newBeakerHeight = KONVA_BEAKER_BASE_SIZE.height * scaleRatio;
                konvaBeaker.width(newBeakerWidth);
                konvaBeaker.height(newBeakerHeight);
                konvaBeaker.x(newStageWidth / 2 - newBeakerWidth / 2);
                konvaBeaker.y(newStageHeight - newBeakerHeight - (0.05 * newStageHeight));
                konvaBeaker.strokeWidth(Math.max(1, 2 * scaleRatio));
                konvaBeaker.cornerRadius([0, 0, newBeakerWidth * 0.1, newBeakerWidth * 0.1]);
                updateKonvaBeakerLabelPosition();
            }
            
            if (konvaSolution) {
                updateKonvaSolutionVisualState();
            }

            konvaLayer.find('.dynamic-chemical').forEach(group => {
                 const rect = group.findOne('Rect');
                 const text = group.findOne('Text');
                 const baseChemicalSize = 60; 
                 const newChemicalWidth = baseChemicalSize * scaleRatio;
                 const newChemicalHeight = (baseChemicalSize * 1.2) * scaleRatio; 

                 rect.width(newChemicalWidth).height(newChemicalHeight);
                 text.fontSize(Math.max(8, 10 * scaleRatio)).width(newChemicalWidth).height(newChemicalHeight);
            });

            konvaStage.batchDraw();
            konvaEffectsLayer.batchDraw(); 
        }


        function updateKonvaBeakerLabelPosition() {
            if (!konvaBeaker || !konvaBeakerLabel || !konvaStage) return;
            konvaBeakerLabel.fontSize(Math.max(10, (16 / KONVA_INITIAL_STAGE_WIDTH) * konvaStage.width()));
            konvaBeakerLabel.x(konvaBeaker.x() + konvaBeaker.width() / 2);
            konvaBeakerLabel.y(konvaBeaker.y() + konvaBeaker.height() / 2 - konvaBeakerLabel.height()/2 * 0.5); 
            konvaBeakerLabel.offsetX(konvaBeakerLabel.width() / 2);
            konvaBeakerLabel.offsetY(konvaBeakerLabel.height() / 2);
        }
        
        function updateKonvaSolutionVisualState() {
            if (!konvaSolution || !konvaBeaker || !konvaStage) { 
                console.warn("[updateKonvaSolutionVisualState] Konva elements not fully initialized.");
                return;
            }
            console.log("[updateKonvaSolutionVisualState] Konva chemicals in beaker:", konvaChemicalsInBeaker.length);
            
            const currentBeakerWidth = konvaBeaker.width();
            const currentBeakerHeight = konvaBeaker.height();
            const padding = currentBeakerWidth * KONVA_SOLUTION_PADDING_RATIO;

            konvaSolution.x(konvaBeaker.x() + padding);
            konvaSolution.width(currentBeakerWidth - 2 * padding);

            if (konvaChemicalsInBeaker.length === 0) {
                konvaSolution.height(0);
                konvaSolution.y(konvaBeaker.y() + currentBeakerHeight - padding); 
                konvaSolution.visible(false);
            } else {
                const maxRise = currentBeakerHeight * KONVA_MAX_LIQUID_RISE_RATIO;
                const numChemicalTypesForMaxRise = 5; 
                const risePerChemicalDrop = maxRise / numChemicalTypesForMaxRise; 
                
                let targetHeight = Math.min(konvaChemicalsInBeaker.length * risePerChemicalDrop, maxRise);
                targetHeight = Math.min(targetHeight, currentBeakerHeight - 2 * padding); 

                konvaSolution.height(targetHeight);
                konvaSolution.y(konvaBeaker.y() + currentBeakerHeight - targetHeight - padding);
                konvaSolution.visible(true);
            }
            konvaLayer.batchDraw();
        }

        function addKonvaChemicalFromData(chemicalData, firestoreId) {
            if (!konvaStage || !konvaLayer) {
                showToast("Phòng thí nghiệm chưa sẵn sàng.");
                return;
            }
             if (!currentUserId) {
                showToast("Vui lòng đăng nhập để tương tác với phòng thí nghiệm.");
                return;
            }
            console.log(`[addKonvaChemicalFromData] Creating Konva object for: ${chemicalData.name}`);
            
            const scaleRatio = konvaStage.width() / KONVA_INITIAL_STAGE_WIDTH;
            const chemicalBaseSize = 60; 
            const chemicalWidth = chemicalBaseSize * scaleRatio;
            const chemicalHeight = chemicalBaseSize * 1.2 * scaleRatio; 
            const fontSize = Math.max(8, 10 * scaleRatio);

            const spawnMargin = 30 * scaleRatio;
            const spawnX = spawnMargin + Math.random() * (konvaStage.width() - chemicalWidth - 2 * spawnMargin);
            const spawnY = spawnMargin + Math.random() * (konvaStage.height() * 0.4 - chemicalHeight); 

            const group = new Konva.Group({
                x: spawnX, 
                y: spawnY, 
                draggable: true, 
                name: 'dynamic-chemical', 
                id: firestoreId, 
                attrs: { chemicalData: chemicalData } 
            });
            const rect = new Konva.Rect({
                width: chemicalWidth, 
                height: chemicalHeight, 
                fill: chemicalData.solutionColor ? chemicalData.solutionColor.replace(/[\d\.]+\)$/g, '0.8)') : 'rgba(200,200,200,0.8)', 
                stroke: 'rgba(50,50,70,0.9)', 
                strokeWidth: Math.max(0.5, 1 * scaleRatio), 
                cornerRadius: 5 * scaleRatio,
                shadowColor: 'black', shadowBlur: 5 * scaleRatio, shadowOpacity: 0.2, shadowOffsetX: 1*scaleRatio, shadowOffsetY: 1*scaleRatio,
            });
            group.add(rect);
            const text = new Konva.Text({
                text: chemicalData.formula || chemicalData.name.substring(0,10), 
                fontSize: fontSize,
                fontFamily: 'Inter, sans-serif',
                fill: 'black', 
                padding: 3 * scaleRatio, 
                width: rect.width(),
                height: rect.height(), 
                align: 'center', 
                verticalAlign: 'middle',
                listening: false 
            });
            group.add(text);
            konvaLayer.add(group);
            group.moveToTop(); 

            group.on('dragstart', function() {
                this.moveToTop(); 
                this.to({ scaleX: 1.1, scaleY: 1.1, duration: 0.1 });
                konvaLayer.batchDraw();
            });

            group.on('click tap', function(evt) {
                if (this.isDragging() || (this.getStage() && this.getStage().isDragging && this.getStage().isDragging())) { 
                    return; 
                }
                const data = this.attrs.chemicalData;
                console.log("[Konva Chemical Click] Displaying info for:", data.name);
                displayChemicalInfoInPanel(data); 
            });

            group.on('dragend', function() {
                this.to({ scaleX: 1, scaleY: 1, duration: 0.1 });
                const droppedChemicalData = this.attrs.chemicalData; 
                const beakerRect = konvaBeaker.getClientRect({relativeTo: konvaStage}); 
                const chemicalRect = this.getClientRect({relativeTo: konvaStage});

                if (Konva.Util.haveIntersection(beakerRect, chemicalRect)) {
                    showToast(`Đã thêm ${droppedChemicalData.name} vào cốc.`);
                    konvaChemicalsInBeaker.push(droppedChemicalData); 
                    console.log("[Konva DragEnd] Chemicals in beaker:", JSON.stringify(konvaChemicalsInBeaker.map(c => c.name)));
                    updateKonvaSolutionVisualState(); 
                    triggerKonvaReactionAI(); 
                    this.destroy(); 
                } 
                konvaLayer.batchDraw();
            });
            konvaLayer.batchDraw();
        }
        
        async function triggerKonvaReactionAI() {
            if (konvaChemicalsInBeaker.length < 1) { 
                stopAllKonvaEffects(); 
                updateKonvaSolutionVisualState(); 
                if(konvaSolution) konvaSolution.fill('rgba(173, 216, 230, 0.3)'); 
                document.getElementById('responseContainer').textContent = "Cốc thí nghiệm trống hoặc chỉ có một hóa chất (chưa đủ để phản ứng).";
                konvaLayer.batchDraw();
                return;
            }
            stopAllKonvaEffects(); 
            const chemicalNamesInBeaker = konvaChemicalsInBeaker.map(c => c.name).join(', ');
            document.getElementById('responseContainer').textContent = `Đang phân tích phản ứng giữa: ${chemicalNamesInBeaker}...`;
            
            const detailedChemicalsForAI = konvaChemicalsInBeaker.map(chem => ({
                name: chem.name, 
                formula: chem.formula, 
                specificReactions: chem.specificReactions || [] 
            }));

            const prompt = `Phân tích phản ứng hóa học có thể xảy ra khi trộn các hóa chất sau trong một cốc thí nghiệm: ${JSON.stringify(detailedChemicalsForAI, null, 2)}. 
Hãy cung cấp kết quả dưới dạng một đối tượng JSON duy nhất, bao gồm các trường sau:
- "reactionOccurred": (boolean) Phản ứng có xảy ra không.
- "mainReactionEquation": (string, optional) Phương trình hóa học chính của phản ứng (nếu có).
- "products": (array of strings, optional) Tên các sản phẩm chính tạo thành.
- "visualPhenomena": { 
    "colorChangeTo": (string, optional) Màu RGBA mới của dung dịch (ví dụ: "rgba(100,255,100,0.7)"). Nếu không đổi màu đáng kể, có thể bỏ qua hoặc giữ màu hỗn hợp.
    "gasEvolution": (boolean, optional) Có sủi bọt khí không.
    "precipitateFormation": (boolean, optional) Có tạo kết tủa không.
    "precipitateColor": (string, optional) Mô tả màu kết tủa bằng tiếng Việt (ví dụ: "trắng", "vàng nhạt", "xanh lam").
    "smokeOrVapor": (boolean, optional) Có khói hoặc hơi bay lên không.
    "temperatureChange": (string, optional) Mô tả thay đổi nhiệt độ (ví dụ: "tỏa nhiệt mạnh", "thu nhiệt", "không đáng kể").
  }
- "explanation": (string) Giải thích chi tiết về hiện tượng, phản ứng và kết quả bằng tiếng Việt.
Output chỉ là JSON object.
`;
            const rawReactionJson = await callGeminiAPI(prompt, null); 

            if (rawReactionJson) {
                try {
                    const cleanedJsonText = rawReactionJson.replace(/^```json\s*([\s\S]*?)\s*```$/, '$1').trim();
                    console.log("AI Reaction Analysis Parsed JSON Text:", cleanedJsonText);
                    const reactionData = JSON.parse(cleanedJsonText);
                    
                    let responseHTML = `<strong>Giải thích từ AI:</strong><br>${reactionData.explanation || "Không có giải thích."}`;
                    if (reactionData.mainReactionEquation) responseHTML += `<br><strong>Phương trình:</strong> ${reactionData.mainReactionEquation}`;
                    if (reactionData.products && reactionData.products.length > 0) responseHTML += `<br><strong>Sản phẩm:</strong> ${reactionData.products.join(', ')}`;
                    document.getElementById('responseContainer').innerHTML = responseHTML;

                    if (reactionData.reactionOccurred && reactionData.visualPhenomena) {
                        const phenomena = reactionData.visualPhenomena;
                        if (phenomena.colorChangeTo && konvaSolution) {
                             konvaSolution.fill(phenomena.colorChangeTo);
                        }
                        if (phenomena.gasEvolution) startKonvaBubblingEffect();
                        if (phenomena.precipitateFormation) startKonvaPrecipitateEffect(phenomena.precipitateColor); 
                        if (phenomena.smokeOrVapor) startKonvaSmokeEffect();
                    }
                } catch (parseError) {
                    console.error("Lỗi khi parse JSON phản ứng từ AI:", parseError, "Raw text:", rawReactionJson);
                    document.getElementById('responseContainer').textContent = `Lỗi AI: Không thể phân tích phản hồi phản ứng. ${parseError.message}`;
                }
            } else {
                document.getElementById('responseContainer').textContent = `Lỗi AI: Không nhận được phản hồi phân tích phản ứng.`;
            }
            if (konvaLayer) konvaLayer.batchDraw();
            if (konvaEffectsLayer) konvaEffectsLayer.batchDraw();
        }
        
        function getEffectBoundary() {
            if (!konvaSolution || !konvaSolution.visible() || konvaSolution.height() === 0) return null;
            return {
                x: konvaSolution.x(),
                y: konvaSolution.y(),
                width: konvaSolution.width(),
                height: konvaSolution.height(),
                topY: konvaSolution.y(), 
                bottomY: konvaSolution.y() + konvaSolution.height() 
            };
        }

        function startKonvaBubblingEffect() {
            console.log("[KonvaEffect] Starting Bubbling");
            if (konvaBubbleAnimation) konvaBubbleAnimation.stop();
            if(konvaEffectsLayer) konvaEffectsLayer.find('.bubble').forEach(n => n.destroy());
            
            konvaBubbleAnimation = new Konva.Animation(frame => {
                if (!frame || !konvaEffectsLayer) return;
                const bounds = getEffectBoundary();
                if (!bounds) { konvaBubbleAnimation.stop(); return; }

                if (frame.timeDiff > 100 && Math.random() < 0.3) { 
                    const bubble = new Konva.Circle({ 
                        x: bounds.x + Math.random() * bounds.width,
                        y: bounds.bottomY - (5 * (konvaStage.width()/KONVA_INITIAL_STAGE_WIDTH)), 
                        radius: (Math.random() * 2 + 1) * (konvaStage.width()/KONVA_INITIAL_STAGE_WIDTH), 
                        fill: 'rgba(255, 255, 255, 0.7)', 
                        opacity: 0.7, 
                        name: 'bubble'
                    });
                    konvaEffectsLayer.add(bubble);
                    new Konva.Tween({
                        node: bubble, 
                        duration: Math.random() * 1.5 + 1, 
                        y: bounds.topY + (10 * (konvaStage.width()/KONVA_INITIAL_STAGE_WIDTH)), 
                        opacity: 0, 
                        onFinish: () => bubble.destroy()
                    }).play();
                }
            }, konvaEffectsLayer);
            konvaBubbleAnimation.start();
        }
        function startKonvaSmokeEffect() {
            console.log("[KonvaEffect] Starting Smoke");
            if (konvaSmokeAnimation) konvaSmokeAnimation.stop();
            if(konvaEffectsLayer) konvaEffectsLayer.find('.smoke').forEach(n => n.destroy());

            konvaSmokeAnimation = new Konva.Animation(frame => {
                if (!frame || !konvaEffectsLayer || !konvaBeaker) return;
                const scaleRatio = konvaStage.width()/KONVA_INITIAL_STAGE_WIDTH;

                if (frame.timeDiff > 150 && Math.random() < 0.25) { 
                    const smoke = new Konva.Ellipse({ 
                        x: konvaBeaker.x() + konvaBeaker.width() / 2 + (Math.random() - 0.5) * konvaBeaker.width() * 0.5, 
                        y: konvaBeaker.y() - (8 * scaleRatio), 
                        radiusX: (Math.random() * 10 + 8) * scaleRatio, 
                        radiusY: (Math.random() * 6 + 5) * scaleRatio,
                        fill: 'rgba(180,180,180,0.25)', 
                        opacity: 0.5, 
                        name: 'smoke'
                    });
                    konvaEffectsLayer.add(smoke);
                    new Konva.Tween({
                        node: smoke, 
                        duration: Math.random() * 2.5 + 2, 
                        y: konvaBeaker.y() - (50 * scaleRatio), 
                        opacity: 0, 
                        scaleX: 1.8, scaleY: 1.8, 
                        onFinish: () => smoke.destroy()
                    }).play();
                }
            }, konvaEffectsLayer);
            konvaSmokeAnimation.start();
        }
        function startKonvaPrecipitateEffect(precipitateColorDescription = "trắng") {
            console.log("[KonvaEffect] Starting Precipitate, color:", precipitateColorDescription);
            if (konvaPrecipitateAnimation) konvaPrecipitateAnimation.stop();
            if(konvaEffectsLayer) konvaEffectsLayer.find('.precipitate').forEach(n => n.destroy());
            
            let fillColor = 'rgba(250, 250, 250, 0.9)'; 
            if (precipitateColorDescription) {
                const desc = precipitateColorDescription.toLowerCase();
                if (desc.includes("vàng")) fillColor = 'rgba(255, 255, 204, 0.9)'; 
                else if (desc.includes("xanh lam")) fillColor = 'rgba(173, 216, 230, 0.9)'; 
                else if (desc.includes("đen")) fillColor = 'rgba(50, 50, 50, 0.9)'; 
            }

            konvaPrecipitateAnimation = new Konva.Animation(frame => {
                if (!frame || !konvaEffectsLayer) return;
                const bounds = getEffectBoundary();
                if (!bounds) { konvaPrecipitateAnimation.stop(); return; }
                const scaleRatio = konvaStage.width()/KONVA_INITIAL_STAGE_WIDTH;

                if (frame.timeDiff > 50 && Math.random() < 0.4) { 
                    const particle = new Konva.Circle({ 
                        x: bounds.x + Math.random() * bounds.width,
                        y: bounds.topY + Math.random() * bounds.height * 0.3, 
                        radius: (Math.random() * 1.5 + 0.8) * scaleRatio, 
                        fill: fillColor, 
                        name: 'precipitate'
                    });
                    konvaEffectsLayer.add(particle);
                    new Konva.Tween({
                        node: particle, 
                        duration: Math.random() * 3 + 2.5, 
                        y: bounds.bottomY - particle.radius() - (3 * scaleRatio), 
                        easing: Konva.Easings.EaseIn
                    }).play();
                }
            }, konvaEffectsLayer);
            konvaPrecipitateAnimation.start();
        }

        function stopAllKonvaEffects() {
            console.log("[KonvaEffect] Stopping all effects");
            if (konvaBubbleAnimation) konvaBubbleAnimation.stop();
            if (konvaSmokeAnimation) konvaSmokeAnimation.stop();
            if (konvaPrecipitateAnimation) konvaPrecipitateAnimation.stop();
            if(konvaEffectsLayer) {
                konvaEffectsLayer.find('.bubble, .smoke').forEach(n => n.destroy()); 
                konvaEffectsLayer.batchDraw();
            }
        }
        
        document.getElementById('resetBeakerButton').addEventListener('click', () => {
            konvaChemicalsInBeaker = [];
            stopAllKonvaEffects();
            if(konvaEffectsLayer) konvaEffectsLayer.find('.precipitate').forEach(n => n.destroy()); 

            if(konvaSolution) konvaSolution.fill('rgba(173, 216, 230, 0.3)'); 
            updateKonvaSolutionVisualState(); 
            
            if (konvaLayer) konvaLayer.batchDraw();
            if (konvaEffectsLayer) konvaEffectsLayer.batchDraw();

            document.getElementById('responseContainer').textContent = "Cốc đã được làm sạch.";
            showToast("Cốc đã được làm sạch.");
        });
        
        document.getElementById('sendPromptButtonLab').addEventListener('click', () => {
            const promptText = document.getElementById('promptInput').value;
            callGeminiAPI(promptText); 
        });

    </script>
</body>
</html>
