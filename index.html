<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Lab - Xác thực & Firestore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Core (luôn cần thiết) -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js"></script>
    <!-- Firebase Authentication -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js"></script>
    <!-- Firebase Firestore -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js"></script>
    <!-- Firebase AI Logic SDK -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.8.1/firebase-ai.js"></script>
    <!-- Konva.js -->
    <script src="https://unpkg.com/konva@9.3.6/konva.min.js"></script>
    <style>
        body { font-family: sans-serif; overscroll-behavior: none; }
        #konva-stage-container canvas { max-width: 100%; height: auto !important; }
        .custom-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
        .custom-toast.show { opacity: 1; }
        /* Style cho form xác thực */
        .auth-form-container { max-width: 400px; margin: 2rem auto; padding: 2rem; background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .lab-hidden { display: none !important; } /* Ẩn phòng thí nghiệm khi chưa đăng nhập */
        .api-error-notice { background-color: #fff3cd; border-color: #ffeeba; color: #856404; padding: .75rem 1.25rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: .25rem; }
         .info-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            max-width: 90%;
            width: 500px;
            z-index: 5000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            max-height: 80vh; /* Giới hạn chiều cao */
            overflow-y: auto; /* Thêm cuộn nếu nội dung dài */
        }
        .info-panel.hidden {
            display: none;
        }
        .info-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 4999;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .info-panel-overlay.hidden {
            display: none;
        }
        .confirm-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 4000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .confirm-modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Khu vực Xác thực -->
    <div id="auth-container" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md mb-4 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
            <p class="font-bold">Lưu ý quan trọng:</p>
            <p>1. Để sử dụng chức năng đăng nhập/đăng ký bằng Email, bạn cần kích hoạt phương thức "Email/Password" trong Firebase Console -> Authentication -> Sign-in method.</p>
            <p class="mt-2">2. Để chức năng "Tạo Hóa Chất" hoạt động, hãy đảm bảo dịch vụ "Generative Language API" (hoặc Vertex AI) đã được bật cho dự án của bạn trong Google Cloud Console.</p>
        </div>
        <div id="user-status" class="w-full max-w-md mb-4 p-3 bg-white rounded shadow text-center">
            <p id="user-email-display">Chưa đăng nhập</p>
            <button id="signOutButton" class="hidden mt-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded text-sm">Đăng xuất</button>
        </div>

        <div id="login-form-container" class="auth-form-container">
            <h2 class="text-2xl font-bold text-blue-700 text-center mb-6">Đăng Nhập</h2>
            <input type="email" id="loginEmail" placeholder="Email" class="w-full p-2 mb-3 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
            <input type="password" id="loginPassword" placeholder="Mật khẩu" class="w-full p-2 mb-4 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
            <button id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded mb-2">Đăng Nhập</button>
            <p class="text-center text-sm">Chưa có tài khoản? <a href="#" id="showRegisterLink" class="text-blue-600 hover:underline">Đăng ký ngay</a></p>
        </div>

        <div id="register-form-container" class="auth-form-container hidden">
            <h2 class="text-2xl font-bold text-green-700 text-center mb-6">Đăng Ký</h2>
            <input type="email" id="registerEmail" placeholder="Email" class="w-full p-2 mb-3 border border-gray-300 rounded focus:ring-2 focus:ring-green-500">
            <input type="password" id="registerPassword" placeholder="Mật khẩu (ít nhất 6 ký tự)" class="w-full p-2 mb-4 border border-gray-300 rounded focus:ring-2 focus:ring-green-500">
            <button id="registerButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded mb-2">Đăng Ký</button>
            <p class="text-center text-sm">Đã có tài khoản? <a href="#" id="showLoginLink" class="text-green-600 hover:underline">Đăng nhập</a></p>
        </div>
    </div>

    <!-- Khu vực Phòng Thí Nghiệm (ban đầu bị ẩn) -->
    <div id="lab-section" class="lab-hidden p-4 md:p-8">
        <h1 class="text-2xl md:text-3xl font-bold text-blue-700 text-center mb-6">Phòng Thí Nghiệm Mô Phỏng AI</h1>
        
        <div class="mb-6 p-4 bg-white rounded shadow">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Tạo Hóa Chất Mới (AI Hỗ Trợ)</h3>
            <div id="gemini-api-error-notice" class="api-error-notice hidden">
                <p class="font-bold">Lỗi kết nối Gemini API!</p>
                <p>Vui lòng kiểm tra cấu hình dự án Firebase của bạn và đảm bảo dịch vụ Generative Language API đã được bật trên Google Cloud Console.</p>
            </div>
            <div class="flex gap-2">
                <input type="text" id="chemicalNameInput" placeholder="Nhập tên hóa chất (ví dụ: Axit Sunfuric)" class="flex-grow p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500">
                <button id="createChemicalButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded">Tạo Hóa Chất</button>
            </div>
            <div id="aiChemicalDefinitionArea" class="mt-4 p-3 border rounded bg-gray-50 min-h-[100px] whitespace-pre-line">
                Thông tin hóa chất từ AI sẽ hiển thị ở đây...
            </div>
        </div>
        
        <div class="mb-6 p-4 bg-white rounded shadow">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Hóa Chất Của Bạn</h3>
            <div id="userChemicalsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 min-h-[100px] bg-gray-50 p-2 rounded border">
                <p class="text-gray-500 col-span-full text-center py-4">Chưa có hóa chất nào được lưu.</p>
            </div>
        </div>

        <!-- NEW SECTION: Quản lý Thí Nghiệm -->
        <div class="mb-6 p-4 bg-white rounded shadow">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Quản Lý Thí Nghiệm</h3>
            <div class="flex gap-2 mb-4">
                <input type="text" id="experimentNameInput" placeholder="Nhập tên thí nghiệm" class="flex-grow p-2 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">
                <button id="saveExperimentButton" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded">Lưu Thí Nghiệm Hiện Tại</button>
            </div>
            <h4 class="text-lg font-semibold text-gray-700 mb-2">Các Thí Nghiệm Đã Lưu:</h4>
            <div id="userExperimentsContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 min-h-[100px] bg-gray-50 p-2 rounded border">
                <p class="text-gray-500 col-span-full text-center py-4">Bạn chưa lưu thí nghiệm nào.</p>
            </div>
        </div>
        <!-- END NEW SECTION -->


        <div id="lab-container" class="flex flex-col md:flex-row md:justify-around w-full max-w-6xl mx-auto gap-4">
            <div id="konva-outer-container" class="w-full md:w-2/3 bg-gray-200 border border-gray-300 rounded-lg shadow p-2 flex justify-center items-center touch-none"> 
                <div id="konva-stage-container"></div>
            </div>

            <div id="ai-controls-container" class="w-full md:w-1/3 flex flex-col bg-white p-4 border border-gray-300 rounded-lg shadow">
                <h2 class="text-xl font-semibold text-blue-600 mb-3">Kết quả & Tương tác AI</h2>
                <h3 class="text-lg font-semibold text-blue-600 mb-2">Phản hồi từ Gemini:</h3>
                <div id="responseContainer" class="p-3 border border-gray-200 bg-gray-50 rounded-md min-h-[150px] whitespace-pre-wrap flex-grow overflow-y-auto mb-4">
                    Chưa có phản hồi...
                </div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Gửi lời nhắc thủ công:</h3>
                <div id="controls" class="flex flex-col">
                    <textarea id="promptInput" rows="3" placeholder="Nhập lời nhắc thủ công ở đây..." class="w-full p-2 border border-gray-300 rounded-md mb-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    <button id="sendPromptButtonLab" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded mb-2">Gửi tới Gemini (Thí nghiệm)</button>
                </div>
                <button id="resetBeakerButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 mt-4">Làm sạch cốc</button>
            </div>
        </div>
    </div>
    <div id="customToast" class="custom-toast"></div>

    <div id="confirmSaveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/3">
            <h3 class="text-xl font-bold mb-4">Xác nhận Lưu Hóa Chất</h3>
            <div id="confirmChemicalDetails" class="mb-4 text-sm max-h-60 overflow-y-auto">
                {/* Chi tiết hóa chất từ AI sẽ được chèn vào đây */}
            </div>
            <p class="mb-4">Bạn có muốn lưu hóa chất này vào kho lưu trữ cá nhân không?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelSaveChemical" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded">Hủy</button>
                <button id="confirmSaveChemicalButtonAction" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded">Lưu</button>
            </div>
        </div>
    </div>

    <!-- Info Panel cho hóa chất -->
    <div id="info-panel-overlay" class="info-panel-overlay hidden"></div>
    <div id="info-panel" class="info-panel hidden">
        <button id="info-panel-close-x" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
        <h3 id="info-panel-title" class="text-2xl font-bold mb-3 text-blue-700"></h3>
        <div id="info-panel-description" class="text-gray-700 text-base leading-relaxed"></div>
        <button id="info-panel-close-button" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md w-full">Đóng</button>
    </div>

    <!-- Modal xác nhận xóa thí nghiệm -->
    <div id="confirmDeleteExperimentModal" class="confirm-modal hidden">
        <div class="confirm-modal-content">
            <h3 class="text-xl font-bold mb-4">Xác nhận xóa thí nghiệm</h3>
            <p id="confirmDeleteExperimentText" class="mb-4">Bạn có chắc chắn muốn xóa thí nghiệm "<span class="font-semibold" id="experimentToDeleteName"></span>" không?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDeleteExperiment" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded">Hủy</button>
                <button id="confirmDeleteExperiment" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded">Xóa</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import các hàm từ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            getDocs,
            onSnapshot, 
            serverTimestamp,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-ai.js";


        const firebaseConfig = {
            apiKey: "AIzaSyAnWoc5pBabK2OfFeCau61X1PioBR5gBD8", // <-- Thay bằng API key của bạn từ Firebase Console
            authDomain: "ailab-9ef87.firebaseapp.com",
            projectId: "ailab-9ef87",
            storageBucket: "ailab-9ef87.firebasestorage.app", 
            messagingSenderId: "558122624068",
            appId: "1:558122624068:web:bde003000c6568f5e74811"
        };
        const app = initializeApp(firebaseConfig);
        
        const auth = getAuth(app);
        const db = getFirestore(app);
        console.log("Firebase App, Auth, and Firestore initialized with new config!");

        let geminiModel;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            geminiModel = getGenerativeModel(ai, { model: "gemini-2.0-flash" }); // Using gemini-2.0-flash as specified in previous instructions
            console.log("Generative Model instance created with model 'gemini-2.0-flash'!");
        } catch (e) {
            console.error("Lỗi khi khởi tạo AI Model:", e);
            document.getElementById("gemini-api-error-notice").classList.remove('hidden');
            document.getElementById("gemini-api-error-notice").innerHTML = `<p class="font-bold">Lỗi khởi tạo AI Model!</p><p>${e.message}. Vui lòng kiểm tra cấu hình dự án Firebase của bạn và đảm bảo dịch vụ Generative Language API đã được bật.</p>`;
        }


        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-ai-lab-app';
        let currentUserId = null; 
        let currentSelectedAiChemical = null; 

        // NEW: Experiment related variables
        let currentExperimentId = null; // ID of the currently loaded/saved experiment
        let currentExperimentData = null; // Data of the currently loaded experiment

        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const authContainer = document.getElementById('auth-container');
        const labSection = document.getElementById('lab-section');
        const userEmailDisplay = document.getElementById('user-email-display');
        const signOutButton = document.getElementById('signOutButton');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const registerButton = document.getElementById('registerButton');
        const showRegisterLink = document.getElementById('showRegisterLink');
        const showLoginLink = document.getElementById('showLoginLink');
        const chemicalNameInput = document.getElementById('chemicalNameInput');
        const createChemicalButton = document.getElementById('createChemicalButton');
        const aiChemicalDefinitionArea = document.getElementById('aiChemicalDefinitionArea');
        const userChemicalsContainer = document.getElementById('userChemicalsContainer');
        const confirmSaveModal = document.getElementById('confirmSaveModal');
        const confirmChemicalDetails = document.getElementById('confirmChemicalDetails');
        const cancelSaveChemical = document.getElementById('cancelSaveChemical');
        const confirmSaveChemicalButtonAction = document.getElementById('confirmSaveChemicalButtonAction');
        const geminiApiErrorNotice = document.getElementById('gemini-api-error-notice');

        const infoPanel = document.getElementById('info-panel');
        const infoPanelOverlay = document.getElementById('info-panel-overlay');
        const infoPanelTitle = document.getElementById('info-panel-title');
        const infoPanelDescription = document.getElementById('info-panel-description');
        const infoPanelCloseButton = document.getElementById('info-panel-close-button');
        const infoPanelCloseX = document.getElementById('info-panel-close-x');

        // NEW: Experiment DOM elements
        const experimentNameInput = document.getElementById('experimentNameInput');
        const saveExperimentButton = document.getElementById('saveExperimentButton');
        const userExperimentsContainer = document.getElementById('userExperimentsContainer');
        const confirmDeleteExperimentModal = document.getElementById('confirmDeleteExperimentModal');
        const confirmDeleteExperimentText = document.getElementById('confirmDeleteExperimentText');
        const experimentToDeleteName = document.getElementById('experimentToDeleteName');
        const cancelDeleteExperiment = document.getElementById('cancelDeleteExperiment');
        const confirmDeleteExperiment = document.getElementById('confirmDeleteExperiment');

        let experimentIdToDelete = null; // To store ID of experiment to delete

        function showToast(message) {
            const toast = document.getElementById('customToast');
            if (toast) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000); 
            } else {
                console.warn("Custom toast element not found. Message:", message);
            }
        }

        async function callGeminiAPI(promptText) {
            const responseContainer = document.getElementById("responseContainer"); 
            
            if (!geminiModel) {
                const errorMessage = "Mô hình AI chưa được khởi tạo. Vui lòng kiểm tra console để biết lỗi.";
                if (responseContainer) {
                    responseContainer.innerText = errorMessage;
                }
                console.error(errorMessage);
                return;
            }
            if (!promptText || !promptText.trim()) {
                if (typeof showToast === 'function') {
                    showToast("Vui lòng nhập lời nhắc cho Gemini.");
                }
                return;
            }

            if (responseContainer) {
                responseContainer.textContent = "Đang gửi yêu cầu đến Gemini...";
            }
            console.log("Calling generic Gemini API with prompt:", promptText);

            try {
                // Using the Firebase AI Logic SDK to generate content
                const result = await geminiModel.generateContent(promptText);
                const response = result.response;
                const text = response.text();
                if(responseContainer) {
                    responseContainer.innerHTML = `<strong>Phản hồi từ AI:</strong><br>${text}`;
                }
                console.log("Response text from generic Gemini API:", text);
            } catch (error) {
                console.error("Lỗi khi gọi Gemini API (chung):", error);
                if (responseContainer) {
                    responseContainer.innerHTML = `<span class="text-red-600 font-bold">Lỗi Gemini: ${error.message}.</span>`;
                }
                 // Show API error notice only if it's an actual API error, not a prompt issue.
                geminiApiErrorNotice.classList.remove('hidden'); 
                geminiApiErrorNotice.innerHTML = `<p class="font-bold">Lỗi kết nối Gemini API!</p><p>${error.message}. Vui lòng kiểm tra cấu hình dự án Firebase của bạn và đảm bảo dịch vụ Generative Language API đã được bật trên Google Cloud Console.</p>`;
            }
        }

        function displayChemicalInfoInPanel(chemicalData) {
            if (chemicalData && infoPanel && infoPanelTitle && infoPanelDescription && infoPanelOverlay) {
                infoPanelTitle.textContent = chemicalData.name || "Thông tin Hóa chất";
                infoPanelDescription.innerHTML = `
                    <p><strong>Công thức:</strong> ${chemicalData.formula || 'N/A'}</p>
                    <p><strong>Dạng:</strong> ${chemicalData.appearance || 'N/A'}</p>
                    <p><strong>Loại:</strong> ${chemicalData.type || 'N/A'}</p>
                    <p><strong>Độ mạnh:</strong> ${chemicalData.strength || 'N/A'}</p>
                    <p><strong>Trạng thái chuẩn:</strong> ${chemicalData.stateAtSTP || 'N/A'}</p>
                    <p><strong>Khả năng tan trong nước:</strong> ${chemicalData.isSoluble !== undefined ? (chemicalData.isSoluble ? 'Tan' : 'Không tan') : 'N/A'}</p>
                    <p><strong>Màu dung dịch:</strong> <span style="display:inline-block; width:20px; height:20px; background-color:${chemicalData.solutionColor || 'transparent'}; border: 1px solid #ccc; vertical-align: middle;"></span> ${chemicalData.solutionColor || 'N/A'}</p>
                    <p><strong>Màu khi khô:</strong> ${chemicalData.colorWhenDry || 'N/A'}</p>
                    ${chemicalData.ionFormation ? `<p><strong>Tạo ion:</strong> Cation: ${chemicalData.ionFormation.cation || 'N/A'}, Anion: ${chemicalData.ionFormation.anion || 'N/A'}</p>` : ''}
                    <p class="mt-3"><strong>Mô tả chi tiết:</strong> ${chemicalData.description || "Không có mô tả chi tiết."}</p>
                    ${chemicalData.density_g_cm3 ? `<p><strong>Khối lượng riêng:</strong> ${chemicalData.density_g_cm3} g/cm³</p>` : ''}
                    ${chemicalData.boiling_point_C ? `<p><strong>Nhiệt độ sôi:</strong> ${chemicalData.boiling_point_C} °C</p>` : ''}
                    ${chemicalData.melting_point_C ? `<p><strong>Nhiệt độ nóng chảy:</strong> ${chemicalData.melting_point_C} °C</p>` : ''}
                    ${chemicalData.isFlammable !== undefined ? `<p><strong>Dễ cháy:</strong> ${chemicalData.isFlammable ? 'Có' : 'Không'}</p>` : ''}
                    ${chemicalData.isReactive !== undefined ? `<p><strong>Dễ phản ứng:</strong> ${chemicalData.isReactive ? 'Có' : 'Không'}</p>` : ''}
                    ${chemicalData.specificReactions && chemicalData.specificReactions.length > 0 ? `
                        <h4 class="font-semibold mt-3 mb-1">Phản ứng đặc trưng:</h4>
                        <ul class="list-disc list-inside">
                            ${chemicalData.specificReactions.map(r => `<li>Với ${r.with}: ${r.phenomenon} (Sản phẩm: ${r.product})</li>`).join('')}
                        </ul>
                    ` : ''}
                `;
                infoPanel.classList.remove('hidden');
                infoPanelOverlay.classList.remove('hidden');
                setTimeout(() => {
                    infoPanel.style.opacity = '1';
                    infoPanel.style.transform = 'translate(-50%, -50%) scale(1)';
                    infoPanelOverlay.style.opacity = '1';
                }, 10);
            } else {
                console.warn("Could not display info panel. Data or panel elements missing.");
            }
        }

        function hideInfoPanel() {
            if (infoPanel && infoPanelOverlay) {
                infoPanel.style.opacity = '0';
                infoPanel.style.transform = 'translate(-50%, -50%) scale(0.95)';
                infoPanelOverlay.style.opacity = '0';
                setTimeout(() => {
                    infoPanel.classList.add('hidden');
                    infoPanelOverlay.classList.add('hidden');
                }, 300); 
            }
        }
        if (infoPanelCloseButton) infoPanelCloseButton.addEventListener('click', hideInfoPanel);
        if (infoPanelCloseX) infoPanelCloseX.addEventListener('click', hideInfoPanel);
        if (infoPanelOverlay) infoPanelOverlay.addEventListener('click', hideInfoPanel);


        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginFormContainer.classList.add('hidden');
            registerFormContainer.classList.remove('hidden');
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerFormContainer.classList.add('hidden');
            loginFormContainer.classList.remove('hidden');
        });

        setPersistence(auth, browserLocalPersistence)
            .then(() => {
                console.log("Firebase Auth persistence set to local.");
            })
            .catch((error) => {
                console.error("Error setting auth persistence:", error);
            });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("User logged in:", currentUserId, user.email);
                userEmailDisplay.textContent = `Đã đăng nhập với: ${user.email} (ID: ${currentUserId.substring(0,6)}...)`;
                signOutButton.classList.remove('hidden');
                authContainer.classList.add('lab-hidden'); 
                labSection.classList.remove('lab-hidden'); 
                loadUserChemicals();
                loadUserExperiments(); // NEW: Load user's experiments
                initializeLabKonva(); 
            } else {
                currentUserId = null;
                console.log("User logged out or not logged in.");
                userEmailDisplay.textContent = "Chưa đăng nhập";
                signOutButton.classList.add('hidden');
                authContainer.classList.remove('lab-hidden'); 
                labSection.classList.add('lab-hidden');     
                clearLabOnLogout();
            }
        });

        loginButton.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) {
                showToast("Vui lòng nhập email và mật khẩu.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("Đăng nhập thành công!");
                loginEmailInput.value = '';
                loginPasswordInput.value = '';
            } catch (error) {
                console.error("Lỗi đăng nhập:", error);
                if (typeof showToast === 'function') {
                    showToast(`Lỗi đăng nhập: ${error.message}`);
                } else {
                    console.error("showToast is not defined in loginButton catch. Error:", `Lỗi đăng nhập: ${error.message}`);
                }
            }
        });

        registerButton.addEventListener('click', async () => {
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            if (!email || !password) {
                showToast("Vui lòng nhập email và mật khẩu.");
                return;
            }
            if (password.length < 6) {
                showToast("Mật khẩu phải có ít nhất 6 ký tự.");
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast("Đăng ký thành công! Đang chuyển đến đăng nhập...");
                registerEmailInput.value = '';
                registerPasswordInput.value = '';
                showLoginLink.click(); 
            } catch (error) {
                console.error("Lỗi đăng ký:", error);
                if (typeof showToast === 'function') {
                    showToast(`Lỗi đăng ký: ${error.message}. Hãy đảm bảo phương thức Email/Password đã được bật trong Firebase Console.`);
                } else {
                    console.error("showToast is not defined in registerButton catch. Error:", `Lỗi đăng ký: ${error.message}`);
                }
            }
        });

        signOutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast("Đã đăng xuất.");
            } catch (error) {
                console.error("Lỗi đăng xuất:", error);
                if (typeof showToast === 'function') {
                    showToast(`Lỗi đăng xuất: ${error.message}`);
                }
            }
        });
        
        createChemicalButton.addEventListener('click', async () => {
            if (!currentUserId) {
                showToast("Vui lòng đăng nhập để tạo hóa chất.");
                return;
            }
            if (!geminiModel) {
                 showToast("Mô hình AI chưa sẵn sàng để tạo hóa chất.");
                 document.getElementById("gemini-api-error-notice").classList.remove('hidden'); // Ensure error notice is visible
                 return;
            }

            const chemicalName = chemicalNameInput.value.trim();
            if (!chemicalName) {
                showToast("Vui lòng nhập tên hóa chất.");
                return;
            }
            aiChemicalDefinitionArea.textContent = "Đang liên hệ với AI để định nghĩa hóa chất...";
            geminiApiErrorNotice.classList.add('hidden'); // Ẩn thông báo lỗi cũ (nếu có)
            currentSelectedAiChemical = null;
            
            const prompt = `Cung cấp thông tin chi tiết về hóa chất "${chemicalName}" dưới dạng một đối tượng JSON. JSON object phải bao gồm các trường sau:
- "name": (string) Tên đầy đủ và phổ biến của hóa chất.
- "formula": (string) Công thức hóa học.
- "appearance": (string) Mô tả ngắn về hình dạng, trạng thái ở điều kiện thường (ví dụ: chất lỏng không màu, chất rắn tinh thể màu trắng).
- "solutionColor": (string) Một chuỗi RGBA đại diện cho màu sắc của dung dịch hóa chất khi hòa tan trong nước (nếu có thể). Ví dụ: "rgba(255, 100, 100, 0.6)" cho màu hồng nhạt, hoặc "rgba(255, 255, 255, 0.1)" nếu không màu/rất nhạt. Nếu là chất rắn không tan, có thể để "rgba(200,200,200,0.7)".
- "description": (string) Mô tả chi tiết hơn về tính chất vật lý, hóa học cơ bản, ứng dụng hoặc cảnh báo an toàn (nếu có).
- "type": (string, optional) Loại hóa chất (ví dụ: "acid", "base", "salt", "metal", "nonmetal", "oxide", "organic").
- "strength": (string, optional) Độ mạnh (ví dụ: "strong", "weak", "moderate"). Áp dụng cho acid, base.
- "stateAtSTP": (string, optional) Trạng thái vật lý ở điều kiện tiêu chuẩn (STP) (ví dụ: "liquid", "solid", "gas").
- "isSoluble": (boolean, optional) Khả năng tan trong nước.
- "ionFormation": (object, optional) Các ion tạo thành khi hòa tan trong nước. Ví dụ: {"cation": "H+", "anion": "Cl-"}.
- "colorWhenDry": (string, optional) Màu sắc của hóa chất khi ở dạng tinh khiết (không hòa tan trong nước, dạng rắn/lỏng nguyên chất).
- "density_g_cm3": (number, optional) Khối lượng riêng (g/cm³) nếu có.
- "boiling_point_C": (number or string, optional) Nhiệt độ sôi (°C) nếu có.
- "melting_point_C": (number or string, optional) Nhiệt độ nóng chảy (°C) nếu có.
- "isFlammable": (boolean, optional) Có dễ cháy không.
- "isReactive": (boolean, optional) Có dễ phản ứng không.
- "specificReactions": (array of objects, optional) Một mảng các phản ứng đặc trưng, mỗi object có dạng {"with": "tên_chất_khác", "phenomenon": "mô_tả_hiện_tượng_trực_quan", "product": "sản_phẩm_chính"}. Chỉ bao gồm 1-2 phản ứng quan trọng nhất.

Hãy đảm bảo output CHỈ LÀ JSON object đó, không có bất kỳ văn bản giải thích nào khác xung quanh JSON. Ví dụ cho HCl:
{
  "name": "Axit Clohydric",
  "formula": "HCl",
  "appearance": "Chất lỏng không màu, bốc khói trong không khí ẩm.",
  "solutionColor": "rgba(255, 255, 255, 0.1)",
  "description": "Là một axit mạnh, ăn mòn nhiều kim loại. Được sử dụng rộng rãi trong công nghiệp và phòng thí nghiệm.",
  "type": "acid",
  "strength": "strong",
  "stateAtSTP": "liquid",
  "isSoluble": true,
  "ionFormation": {"cation": "H+", "anion": "Cl-"},
  "colorWhenDry": "Không màu",
  "density_g_cm3": 1.18,
  "boiling_point_C": "Khoảng -85 (khan) đến 110 (dung dịch 20.2%)",
  "isReactive": true,
  "specificReactions": [
    {"with": "NaOH", "phenomenon": "Phản ứng trung hòa, tỏa nhiệt, có thể có sủi bọt nhẹ.", "product": "NaCl, H2O"},
    {"with": "AgNO3", "phenomenon": "Tạo kết tủa trắng AgCl.", "product": "AgCl"}
  ]
}
`;
            try {
                // Using Firebase AI Logic SDK
                const result = await geminiModel.generateContent(prompt);
                const response = result.response;
                let rawJsonText = response.text();
                
                // Clean up markdown code block if present
                rawJsonText = rawJsonText.replace(/^```json\s*([\s\S]*?)\s*```$/, '$1').trim();
                console.log("Raw JSON text from AI:", rawJsonText);
                currentSelectedAiChemical = JSON.parse(rawJsonText); 
                confirmChemicalDetails.innerHTML = `<pre class="bg-gray-100 p-2 rounded text-xs">${JSON.stringify(currentSelectedAiChemical, null, 2)}</pre>`;
                confirmSaveModal.classList.remove('hidden');
                aiChemicalDefinitionArea.textContent = `AI đã định nghĩa hóa chất: ${currentSelectedAiChemical.name || chemicalName}. Kiểm tra và xác nhận lưu.`;
            } catch (error) {
                console.error("Lỗi khi gọi Gemini API hoặc parse JSON:", error);
                aiChemicalDefinitionArea.textContent = `Lỗi: ${error.message}`;
                geminiApiErrorNotice.classList.remove('hidden'); // Hiển thị thông báo lỗi API
                geminiApiErrorNotice.innerHTML = `<p class="font-bold">Lỗi kết nối Gemini API!</p><p>${error.message}. Vui lòng kiểm tra cấu hình dự án Firebase của bạn và đảm bảo dịch vụ Generative Language API đã được bật trên Google Cloud Console.</p>`;
                currentSelectedAiChemical = null;
            }
        });

        cancelSaveChemical.addEventListener('click', () => {
            confirmSaveModal.classList.add('hidden');
            currentSelectedAiChemical = null; 
            aiChemicalDefinitionArea.textContent = "Đã hủy lưu hóa chất.";
        });
        
        confirmSaveChemicalButtonAction.addEventListener('click', async () => {
            if (!currentSelectedAiChemical || !currentUserId) {
                showToast("Không có thông tin hóa chất để lưu hoặc bạn chưa đăng nhập.");
                confirmSaveModal.classList.add('hidden');
                return;
            }
            try {
                const chemicalToSave = {
                    ...currentSelectedAiChemical,
                    userId: currentUserId, 
                    createdAt: serverTimestamp() 
                };
                const chemicalCollectionRef = collection(db, "artifacts", appId, "users", currentUserId, "customChemicals");
                const docRef = await addDoc(chemicalCollectionRef, chemicalToSave);
                console.log("Hóa chất đã được lưu với ID: ", docRef.id);
                showToast(`Đã lưu hóa chất: ${currentSelectedAiChemical.name || 'Chưa có tên'}`);
                chemicalNameInput.value = ''; 
                aiChemicalDefinitionArea.textContent = "Thông tin hóa chất từ AI sẽ hiển thị ở đây...";
                currentSelectedAiChemical = null; 
                confirmSaveModal.classList.add('hidden');
            } catch (error) {
                console.error("Lỗi khi lưu hóa chất vào Firestore:", error);
                showToast(`Lỗi khi lưu hóa chất: ${error.message}`);
            }
        });

        let unsubscribeUserChemicals = null; 
        let unsubscribeUserExperiments = null; // NEW: Unsubscribe for experiments

        async function loadUserChemicals() {
            if (!currentUserId) {
                console.warn("[loadUserChemicals] No currentUserId, skipping load.");
                return;
            }
            console.log(`[loadUserChemicals] Loading chemicals for user: ${currentUserId} and appId: ${appId}`);
            if (unsubscribeUserChemicals) {
                unsubscribeUserChemicals();
                console.log("[loadUserChemicals] Unsubscribed from previous chemical listener.");
            }
            const chemicalsRef = collection(db, "artifacts", appId, "users", currentUserId, "customChemicals");
            console.log("[loadUserChemicals] Firestore collection path:", chemicalsRef.path);

            unsubscribeUserChemicals = onSnapshot(chemicalsRef, (querySnapshot) => {
                console.log(`[onSnapshot] Received ${querySnapshot.docs.length} chemical documents for user ${currentUserId}.`);
                userChemicalsContainer.innerHTML = ''; 
                if (querySnapshot.empty) {
                    userChemicalsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">Bạn chưa lưu hóa chất nào.</p>';
                    console.log("[onSnapshot] No chemicals found for this user.");
                    return;
                }
                querySnapshot.forEach((docSnap) => {
                    const chemicalData = docSnap.data();
                    const chemicalId = docSnap.id;
                    console.log(`[onSnapshot] Processing chemical: ${chemicalData.name} (ID: ${chemicalId})`);
                    const chemicalElement = document.createElement('div');
                    chemicalElement.className = 'p-3 bg-white border rounded shadow-sm cursor-pointer hover:shadow-md transition-shadow';
                    chemicalElement.setAttribute('data-chemical-id', chemicalId);
                    // Sử dụng màu dung dịch cho nền và màu viền (nhạt hơn một chút để dễ nhìn)
                    const bgColor = chemicalData.solutionColor || 'rgba(200,200,200,0.7)';
                    chemicalElement.style.backgroundColor = bgColor.replace(/[\d\.]+\)$/g, '0.3)'); 
                    chemicalElement.style.borderColor = bgColor.replace(/[\d\.]+\)$/g, '1)'); 
                    const nameEl = document.createElement('h4');
                    nameEl.className = 'font-semibold text-sm mb-1 truncate';
                    nameEl.textContent = chemicalData.name || "Chưa đặt tên";
                    chemicalElement.appendChild(nameEl);
                    const formulaEl = document.createElement('p');
                    formulaEl.className = 'text-xs text-gray-600 mb-2 truncate';
                    formulaEl.textContent = `(${chemicalData.formula || 'N/A'})`;
                    chemicalElement.appendChild(formulaEl);
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '&times;'; 
                    deleteButton.className = 'absolute top-1 right-1 text-xs bg-red-400 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center focus:outline-none';
                    deleteButton.title = "Xóa hóa chất này";
                    deleteButton.style.lineHeight = '1'; 
                    chemicalElement.style.position = 'relative'; 
                    deleteButton.onclick = async (e) => {
                        e.stopPropagation(); 
                        // Using custom modal instead of confirm()
                        // This confirm() is fine for now as it's the only one left after custom modal logic was removed
                        const confirmation = confirm(`Bạn có chắc muốn xóa hóa chất "${chemicalData.name || 'này'}" không?`); 
                        if (confirmation) {
                            try {
                                await deleteDoc(doc(db, "artifacts", appId, "users", currentUserId, "customChemicals", chemicalId));
                                showToast("Đã xóa hóa chất.");
                            } catch (error) {
                                console.error("Lỗi khi xóa hóa chất:", error);
                                showToast(`Lỗi xóa: ${error.message}`);
                            }
                        }
                    };
                    chemicalElement.appendChild(deleteButton);
                    chemicalElement.addEventListener('click', () => {
                        console.log("Clicked on saved chemical:", chemicalData);
                        addKonvaChemicalFromData(chemicalData, chemicalId);
                    });
                    userChemicalsContainer.appendChild(chemicalElement);
                });
            }, (error) => {
                console.error(`Lỗi khi lắng nghe thay đổi hóa chất cho user ${currentUserId}:`, error);
                userChemicalsContainer.innerHTML = '<p class="text-red-500 col-span-full text-center py-4">Lỗi tải danh sách hóa chất.</p>';
            });
        }

        // NEW: Experiment management functions
        async function saveExperiment() {
            if (!currentUserId) {
                showToast("Vui lòng đăng nhập để lưu thí nghiệm.");
                return;
            }
            const name = experimentNameInput.value.trim();
            if (!name) {
                showToast("Vui lòng nhập tên thí nghiệm.");
                return;
            }
            if (konvaChemicalsInBeaker.length === 0) {
                showToast("Cốc thí nghiệm trống. Vui lòng thêm hóa chất trước khi lưu.");
                return;
            }

            try {
                const experimentDataToSave = {
                    name: name,
                    chemicals: konvaChemicalsInBeaker, // Array of chemical data objects
                    userId: currentUserId,
                    createdAt: serverTimestamp()
                };

                // Check if an experiment with this name already exists for the user
                const experimentsRef = collection(db, "artifacts", appId, "users", currentUserId, "experiments");
                const q = query(experimentsRef, where("name", "==", name));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Update existing experiment
                    const existingDoc = querySnapshot.docs[0];
                    await setDoc(doc(db, "artifacts", appId, "users", currentUserId, "experiments", existingDoc.id), experimentDataToSave);
                    showToast(`Đã cập nhật thí nghiệm "${name}"!`);
                    currentExperimentId = existingDoc.id;
                } else {
                    // Add new experiment
                    const docRef = await addDoc(experimentsRef, experimentDataToSave);
                    showToast(`Đã lưu thí nghiệm "${name}" với ID: ${docRef.id}`);
                    currentExperimentId = docRef.id;
                }
                currentExperimentData = experimentDataToSave; // Set as current
                experimentNameInput.value = ''; // Clear input
            } catch (error) {
                console.error("Lỗi khi lưu thí nghiệm:", error);
                showToast(`Lỗi khi lưu thí nghiệm: ${error.message}`);
            }
        }

        async function loadUserExperiments() {
            if (!currentUserId) {
                console.warn("[loadUserExperiments] No currentUserId, skipping load.");
                return;
            }
            console.log(`[loadUserExperiments] Loading experiments for user: ${currentUserId}`);
            if (unsubscribeUserExperiments) {
                unsubscribeUserExperiments();
                console.log("[loadUserExperiments] Unsubscribed from previous experiment listener.");
            }
            const experimentsRef = collection(db, "artifacts", appId, "users", currentUserId, "experiments");

            unsubscribeUserExperiments = onSnapshot(experimentsRef, (querySnapshot) => {
                console.log(`[onSnapshot] Received ${querySnapshot.docs.length} experiment documents.`);
                userExperimentsContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    userExperimentsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">Bạn chưa lưu thí nghiệm nào.</p>';
                    return;
                }
                querySnapshot.forEach((docSnap) => {
                    const experiment = docSnap.data();
                    const experimentId = docSnap.id;
                    const experimentElement = document.createElement('div');
                    experimentElement.className = 'p-3 bg-blue-100 border border-blue-300 rounded shadow-sm flex flex-col justify-between';
                    experimentElement.innerHTML = `
                        <h4 class="font-semibold text-blue-800 text-sm mb-1 truncate">${experiment.name || 'Thí nghiệm không tên'}</h4>
                        <p class="text-xs text-blue-600 mb-2">${experiment.chemicals ? experiment.chemicals.length : 0} hóa chất</p>
                        <div class="flex gap-2 text-xs mt-auto">
                            <button class="flex-grow bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded load-experiment-btn" data-experiment-id="${experimentId}">Tải</button>
                            <button class="flex-grow bg-red-400 hover:bg-red-500 text-white py-1 px-2 rounded delete-experiment-btn" data-experiment-id="${experimentId}" data-experiment-name="${experiment.name || 'thí nghiệm này'}">Xóa</button>
                        </div>
                    `;
                    userExperimentsContainer.appendChild(experimentElement);
                });

                // Add event listeners after elements are added to DOM
                userExperimentsContainer.querySelectorAll('.load-experiment-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const expId = e.target.dataset.experimentId;
                        try {
                            const docRef = doc(db, "artifacts", appId, "users", currentUserId, "experiments", expId);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                const expData = docSnap.data();
                                loadExperimentIntoBeaker(expData, expId);
                                showToast(`Đã tải thí nghiệm "${expData.name}"!`);
                            } else {
                                showToast("Thí nghiệm không tìm thấy.");
                            }
                        } catch (error) {
                            console.error("Lỗi khi tải thí nghiệm:", error);
                            showToast(`Lỗi tải thí nghiệm: ${error.message}`);
                        }
                    });
                });

                userExperimentsContainer.querySelectorAll('.delete-experiment-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        experimentIdToDelete = e.target.dataset.experimentId;
                        const name = e.target.dataset.experimentName;
                        experimentToDeleteName.textContent = name;
                        confirmDeleteExperimentModal.classList.remove('hidden');
                    });
                });
            }, (error) => {
                console.error(`Lỗi khi lắng nghe thay đổi thí nghiệm cho user ${currentUserId}:`, error);
                userExperimentsContainer.innerHTML = '<p class="text-red-500 col-span-full text-center py-4">Lỗi tải danh sách thí nghiệm.</p>';
            });
        }

        function loadExperimentIntoBeaker(experimentData, experimentId) {
            currentExperimentId = experimentId;
            currentExperimentData = experimentData;
            experimentNameInput.value = experimentData.name || ''; // Populate input field with loaded experiment name

            // Clear current beaker state
            konvaChemicalsInBeaker = [];
            stopAllKonvaEffects();
            if(konvaLayer) konvaLayer.find('.dynamic-chemical').forEach(node => node.destroy());
            
            // Add chemicals from loaded experiment to beaker
            if (experimentData.chemicals && experimentData.chemicals.length > 0) {
                experimentData.chemicals.forEach(chemical => {
                    // Note: These chemicals are not the draggable Konva objects, but the raw data
                    // We need to add them to konvaChemicalsInBeaker directly and then trigger visual updates
                    konvaChemicalsInBeaker.push(chemical);
                });
                updateKonvaSolutionVisualState(); // Update liquid level based on new chemicals
                triggerKonvaReactionAI(); // Re-trigger AI analysis for the loaded experiment
                showToast(`Đã tải thí nghiệm "${experimentData.name}".`);
            } else {
                updateKonvaSolutionVisualState(); // Clear beaker if no chemicals
                document.getElementById('responseContainer').textContent = "Thí nghiệm đã tải không có hóa chất.";
                showToast(`Thí nghiệm "${experimentData.name}" không có hóa chất.`);
            }
        }

        async function deleteExperiment(experimentId) {
            if (!currentUserId || !experimentId) return;
            try {
                await deleteDoc(doc(db, "artifacts", appId, "users", currentUserId, "experiments", experimentId));
                showToast("Đã xóa thí nghiệm.");
                if (currentExperimentId === experimentId) { // If currently loaded experiment is deleted
                    resetBeaker(); // Clear the beaker and associated state
                    currentExperimentId = null;
                    currentExperimentData = null;
                    experimentNameInput.value = '';
                }
            } catch (error) {
                console.error("Lỗi khi xóa thí nghiệm:", error);
                showToast(`Lỗi xóa thí nghiệm: ${error.message}`);
            }
            confirmDeleteExperimentModal.classList.add('hidden');
            experimentIdToDelete = null;
        }

        // Event listeners for delete confirmation modal
        cancelDeleteExperiment.addEventListener('click', () => {
            confirmDeleteExperimentModal.classList.add('hidden');
            experimentIdToDelete = null;
        });

        confirmDeleteExperiment.addEventListener('click', () => {
            if (experimentIdToDelete) {
                deleteExperiment(experimentIdToDelete);
            }
        });

        function clearLabOnLogout() {
            console.log("[clearLabOnLogout] Clearing lab data.");
            if (unsubscribeUserChemicals) {
                unsubscribeUserChemicals(); 
                unsubscribeUserChemicals = null;
                console.log("[clearLabOnLogout] Unsubscribed from chemical listener.");
            }
            if (unsubscribeUserExperiments) { // NEW: Unsubscribe experiments
                unsubscribeUserExperiments();
                unsubscribeUserExperiments = null;
                console.log("[clearLabOnLogout] Unsubscribed from experiment listener.");
            }

            userChemicalsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">Vui lòng đăng nhập để xem hóa chất.</p>';
            userExperimentsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">Bạn chưa lưu thí nghiệm nào.</p>'; // NEW: Clear experiments display

            resetBeaker(); // Re-use resetBeaker function to clear Konva state
            currentSelectedAiChemical = null;
            aiChemicalDefinitionArea.textContent = "Thông tin hóa chất từ AI sẽ hiển thị ở đây...";
            geminiApiErrorNotice.classList.add('hidden');
            
            // NEW: Clear current experiment state
            currentExperimentId = null;
            currentExperimentData = null;
            experimentNameInput.value = '';
        }

        let konvaStage, konvaLayer, konvaEffectsLayer; 
        let konvaBeaker, konvaSolution, konvaBeakerLabel;
        let konvaChemicalsInBeaker = []; 
        let konvaBubbleAnimation, konvaSmokeAnimation, konvaPrecipitateAnimation;

        const KONVA_INITIAL_STAGE_WIDTH = 600;
        const KONVA_INITIAL_STAGE_HEIGHT = 400;
        const KONVA_BEAKER_BASE_SIZE = { width: 150, height: 180 };
        const KONVA_BEAKER_BASE_X = KONVA_INITIAL_STAGE_WIDTH / 2 - (KONVA_BEAKER_BASE_SIZE.width / 2);
        const KONVA_BEAKER_BASE_Y = KONVA_INITIAL_STAGE_HEIGHT - KONVA_BEAKER_BASE_SIZE.height - 20;
        const KONVA_MAX_LIQUID_RISE = KONVA_BEAKER_BASE_SIZE.height * 0.7; 
        const KONVA_SOLUTION_PADDING_BASE = 8;

        function initializeLabKonva() {
            console.log("[initializeLabKonva] Initializing Konva stage and objects.");
            // Prevent re-initialization if already active
            if (konvaStage && document.getElementById('konva-stage-container').hasChildNodes()) { 
                console.log("[initializeLabKonva] Konva stage already exists, skipping re-initialization.");
                konvaStage.batchDraw();
                return;
            }
            const konvaStageContainer = document.getElementById('konva-stage-container');
            konvaStageContainer.innerHTML = ''; // Clear previous stage if any

            const konvaOuterEl = document.getElementById('konva-outer-container');
            let currentW = Math.min(KONVA_INITIAL_STAGE_WIDTH, konvaOuterEl.clientWidth > 20 ? konvaOuterEl.clientWidth - 20 : KONVA_INITIAL_STAGE_WIDTH);
            let currentH = KONVA_INITIAL_STAGE_HEIGHT; 
            konvaStage = new Konva.Stage({
                container: 'konva-stage-container',
                width: currentW,
                height: currentH,
            });
            konvaLayer = new Konva.Layer();
            konvaStage.add(konvaLayer);
            konvaEffectsLayer = new Konva.Layer();
            konvaStage.add(konvaEffectsLayer);
            konvaBeaker = new Konva.Rect({
                x: getKonvaResponsiveValue(KONVA_BEAKER_BASE_X, KONVA_INITIAL_STAGE_WIDTH, currentW),
                y: getKonvaResponsiveValue(KONVA_BEAKER_BASE_Y, KONVA_INITIAL_STAGE_HEIGHT, currentH),
                width: getKonvaResponsiveSize(KONVA_BEAKER_BASE_SIZE.width, KONVA_INITIAL_STAGE_WIDTH, currentW).width,
                height: getKonvaResponsiveSize(KONVA_BEAKER_BASE_SIZE.height, KONVA_INITIAL_STAGE_WIDTH, currentW).height, 
                fill: 'rgba(233, 233, 233, 0.5)',
                stroke: 'black',
                strokeWidth: Math.max(1, getKonvaResponsiveValue(2.5, KONVA_INITIAL_STAGE_WIDTH, currentW)),
                name: 'beaker'
            });
            konvaLayer.add(konvaBeaker);
            konvaSolution = new Konva.Rect({
                fill: 'rgba(173, 216, 230, 0.3)',
                name: 'solution',
                visible: false
            });
            konvaLayer.add(konvaSolution); 
            konvaBeaker.moveToTop(); 
            const labelFontSize = Math.max(12, getKonvaResponsiveValue(20, KONVA_INITIAL_STAGE_WIDTH, currentW));
            konvaBeakerLabel = new Konva.Text({
                text: 'Cốc TN',
                fontSize: labelFontSize,
                fill: 'black',
            });
            konvaLayer.add(konvaBeakerLabel);
            updateKonvaBeakerLabelPosition();
            updateKonvaSolutionVisualState(); 
            window.addEventListener('resize', fitKonvaStageToParent);
            fitKonvaStageToParent(); 
            console.log("[initializeLabKonva] Konva initialized.");
        }
        
        function getKonvaResponsiveValue(baseValue, baseStageDim, currentDim) {
            return (baseValue / baseStageDim) * currentDim;
        }
        function getKonvaResponsiveSize(baseDim, baseStageDim, currentDim) {
            const scale = currentDim / baseStageDim;
            return { width: baseDim * scale, height: baseDim * scale }; 
        }

        function updateKonvaBeakerLabelPosition() {
            if (!konvaBeaker || !konvaBeakerLabel) return;
            konvaBeakerLabel.x(konvaBeaker.x() + konvaBeaker.width() / 2);
            konvaBeakerLabel.y(konvaBeaker.y() + konvaBeaker.height() / 2);
            konvaBeakerLabel.offsetX(konvaBeakerLabel.width() / 2);
            konvaBeakerLabel.offsetY(konvaBeakerLabel.height() / 2);
        }
        
        function updateKonvaSolutionVisualState() {
            if (!konvaSolution || !konvaBeaker || !konvaStage) { 
                console.warn("[updateKonvaSolutionVisualState] Konva elements not fully initialized.");
                return;
            }
            console.log("[updateKonvaSolutionVisualState] Konva chemicals:", konvaChemicalsInBeaker.length);
            const padding = getKonvaResponsiveValue(KONVA_SOLUTION_PADDING_BASE, KONVA_INITIAL_STAGE_WIDTH, konvaStage.width());
            konvaSolution.x(konvaBeaker.x() + padding);
            konvaSolution.width(konvaBeaker.width() - 2 * padding);
            if (konvaChemicalsInBeaker.length === 0) {
                konvaSolution.height(0);
                konvaSolution.y(konvaBeaker.y() + konvaBeaker.height() - padding);
                konvaSolution.visible(false);
            } else {
                const maxRise = getKonvaResponsiveValue(KONVA_MAX_LIQUID_RISE, KONVA_INITIAL_STAGE_HEIGHT, konvaStage.height());
                const risePerChemicalDrop = maxRise / (konvaChemicalsInBeaker.length + 5); 
                let targetHeight = Math.min(konvaChemicalsInBeaker.length * risePerChemicalDrop, maxRise);
                targetHeight = Math.min(targetHeight, konvaBeaker.height() - 2 * padding);
                konvaSolution.height(targetHeight);
                konvaSolution.y(konvaBeaker.y() + konvaBeaker.height() - targetHeight - padding);
                konvaSolution.visible(true);
            }
            konvaLayer.batchDraw();
        }

        function addKonvaChemicalFromData(chemicalData, firestoreId) {
            if (!konvaStage || !konvaLayer) {
                showToast("Phòng thí nghiệm chưa sẵn sàng.");
                return;
            }
            console.log(`[addKonvaChemicalFromData] Creating Konva object for: ${chemicalData.name}`);
            const spawnX = getKonvaResponsiveValue(50 + Math.random() * 100, KONVA_INITIAL_STAGE_WIDTH, konvaStage.width());
            const spawnY = getKonvaResponsiveValue(50 + Math.random() * 100, KONVA_INITIAL_STAGE_HEIGHT, konvaStage.height());
            const chemicalSize = getKonvaResponsiveSize(60, KONVA_INITIAL_STAGE_WIDTH, konvaStage.width()); 
            const group = new Konva.Group({
                x: spawnX, y: spawnY, draggable: true, name: 'dynamic-chemical', 
                id: firestoreId, attrs: { chemicalData: chemicalData } 
            });
            const rect = new Konva.Rect({
                width: chemicalSize.width, height: chemicalSize.height * 1.2, 
                fill: chemicalData.solutionColor || 'rgba(200,200,200,0.7)',
                stroke: 'black', strokeWidth: 1, cornerRadius: 5,
                shadowColor: 'black', shadowBlur: 3, shadowOpacity: 0.3,
            });
            group.add(rect);
            const text = new Konva.Text({
                text: chemicalData.formula || chemicalData.name.substring(0,10),
                fontSize: getKonvaResponsiveValue(10, KONVA_INITIAL_STAGE_WIDTH, konvaStage.width()),
                fill: 'black', padding: 5, width: rect.width(),
                align: 'center', verticalAlign: 'middle', height: rect.height()
            });
            group.add(text);
            konvaLayer.add(group);
            group.moveToTop(); 

            group.on('dragstart', function() {
                this.moveToTop(); this.scale({x: 1.1, y: 1.1}); konvaLayer.batchDraw();
            });

            group.on('click tap', function(evt) {
                if (this.isDragging() || (this.getStage() && this.getStage().isDragging && this.getStage().isDragging())) { 
                    return; 
                }
                const data = this.attrs.chemicalData;
                console.log("[Konva Chemical Click] Displaying info for:", data.name);
                displayChemicalInfoInPanel(data); 
            });

            group.on('dragend', function() {
                this.scale({x: 1, y: 1});
                const droppedChemicalData = this.attrs.chemicalData; 
                const beakerRect = konvaBeaker.getClientRect();
                const chemicalRect = this.getClientRect();
                if (Konva.Util.haveIntersection(beakerRect, chemicalRect)) {
                    showToast(`Đã thêm ${droppedChemicalData.name} vào cốc.`);
                    konvaChemicalsInBeaker.push(droppedChemicalData); 
                    console.log("[Konva DragEnd] Chemicals in beaker:", JSON.stringify(konvaChemicalsInBeaker.map(c => c.name)));
                    updateKonvaSolutionVisualState(); 
                    triggerKonvaReactionAI(); 
                    this.destroy(); // Remove the chemical graphic from the canvas once dropped into the beaker
                } 
                konvaLayer.batchDraw();
            });
            konvaLayer.batchDraw();
        }
        
        async function triggerKonvaReactionAI() {
            if (konvaChemicalsInBeaker.length < 1) { 
                stopAllKonvaEffects(); updateKonvaSolutionVisualState(); 
                document.getElementById('responseContainer').textContent = "Cốc thí nghiệm trống hoặc chỉ có một hóa chất (chưa đủ để phản ứng).";
                return;
            }
            if (!geminiModel) {
                 showToast("Mô hình AI chưa sẵn sàng để phân tích phản ứng.");
                 document.getElementById("gemini-api-error-notice").classList.remove('hidden'); // Ensure error notice is visible
                 return;
            }
            stopAllKonvaEffects(); 
            const chemicalNamesInBeaker = konvaChemicalsInBeaker.map(c => c.name).join(', ');
            document.getElementById('responseContainer').textContent = `Đang phân tích phản ứng giữa: ${chemicalNamesInBeaker}...`;
            // Sending more detailed chemical data to AI
            const detailedChemicalsForAI = konvaChemicalsInBeaker.map(chem => ({
                name: chem.name, 
                formula: chem.formula, 
                type: chem.type, 
                strength: chem.strength, 
                stateAtSTP: chem.stateAtSTP, 
                isSoluble: chem.isSoluble, 
                ionFormation: chem.ionFormation, 
                solutionColor: chem.solutionColor, 
                specificReactions: chem.specificReactions 
            }));
            const prompt = `Phân tích phản ứng hóa học có thể xảy ra khi trộn các hóa chất sau trong một cốc thí nghiệm: ${JSON.stringify(detailedChemicalsForAI, null, 2)}. 
Hãy cung cấp kết quả dưới dạng một đối tượng JSON duy nhất, bao gồm các trường sau:
- "reactionOccurred": (boolean) Phản ứng có xảy ra không.
- "mainReactionEquation": (string, optional) Phương trình hóa học chính của phản ứng (nếu có).
- "products": (array of strings, optional) Tên các sản phẩm chính tạo thành.
- "visualPhenomena": { 
    "colorChangeTo": (string, optional) Màu RGBA mới của dung dịch (ví dụ: "rgba(100,255,100,0.7)"). Nếu không đổi màu đáng kể, có thể bỏ qua hoặc giữ màu hỗn hợp.
    "gasEvolution": (boolean, optional) Có sủi bọt khí không.
    "gasEvolutionIntensity": (string, optional) Cường độ sủi bọt khí (ví dụ: "low", "medium", "high", "vigorous").
    "precipitateFormation": (boolean, optional) Có tạo kết tủa không.
    "precipitateColorRGBA": (string, optional) Mã màu RGBA của kết tủa (ví dụ: "rgba(255, 255, 200, 0.9)").
    "smokeOrVapor": (boolean, optional) Có khói hoặc hơi bay lên không.
    "smokeIntensity": (string, optional) Cường độ khói/hơi (ví dụ: "low", "medium", "high").
    "temperatureEffect": (string, optional) Mô tả thay đổi nhiệt độ (ví dụ: "exothermic_strong" (tỏa nhiệt mạnh), "endothermic" (thu nhiệt), "negligible" (không đáng kể)).
  }
- "explanation": (string) Giải thích chi tiết về hiện tượng, phản ứng và kết quả.
Output chỉ là JSON object.
`;
            try {
                // Using Firebase AI Logic SDK
                const result = await geminiModel.generateContent(prompt);
                const response = result.response;
                let rawJsonText = response.text();
                rawJsonText = rawJsonText.replace(/^```json\s*([\s\S]*?)\s*```$/, '$1').trim();
                console.log("AI Reaction Analysis Parsed JSON Text:", rawJsonText);
                const reactionData = JSON.parse(rawJsonText);
                document.getElementById('responseContainer').innerHTML = `<strong>Giải thích từ AI:</strong><br>${reactionData.explanation || "Không có giải thích."}<br><strong>Phương trình (nếu có):</strong> ${reactionData.mainReactionEquation || "N/A"}<br><strong>Sản phẩm:</strong> ${reactionData.products ? reactionData.products.join(', ') : "N/A"}`;
                if (reactionData.reactionOccurred && reactionData.visualPhenomena) {
                    const phenomena = reactionData.visualPhenomena;
                    if (phenomena.colorChangeTo) konvaSolution.fill(phenomena.colorChangeTo);
                    
                    if (phenomena.gasEvolution) startKonvaBubblingEffect(phenomena.gasEvolutionIntensity);
                    if (phenomena.precipitateFormation) startKonvaPrecipitateEffect(phenomena.precipitateColorRGBA); 
                    if (phenomena.smokeOrVapor) startKonvaSmokeEffect(phenomena.smokeIntensity);
                    if (phenomena.temperatureEffect) visualizeTemperatureChange(phenomena.temperatureEffect);
                }
            } catch (error) {
                console.error("Lỗi khi gọi AI phân tích phản ứng:", error);
                document.getElementById('responseContainer').textContent = `Lỗi AI: ${error.message}`;
                geminiApiErrorNotice.classList.remove('hidden'); 
                geminiApiErrorNotice.innerHTML = `<p class="font-bold">Lỗi kết nối Gemini API!</p><p>${error.message}. Vui lòng kiểm tra cấu hình dự án Firebase của bạn và đảm bảo dịch vụ Generative Language API đã được bật trên Google Cloud Console.</p>`;
            }
            konvaLayer.batchDraw();
            konvaEffectsLayer.batchDraw();
        }

        function startKonvaBubblingEffect(intensity = "medium") {
            console.log("[KonvaEffect] Starting Bubbling with intensity:", intensity);
            if (konvaBubbleAnimation) konvaBubbleAnimation.stop();
            konvaEffectsLayer.find('.bubble').forEach(n => n.destroy());
            let interval = 100; // ms
            let countPerInterval = 1;

            if (intensity === "low") { interval = 200; countPerInterval = 1; }
            else if (intensity === "medium") { interval = 100; countPerInterval = 1; }
            else if (intensity === "high") { interval = 50; countPerInterval = 2; }
            else if (intensity === "vigorous") { interval = 30; countPerInterval = 3; }

            konvaBubbleAnimation = new Konva.Animation(frame => {
                if (!frame || !konvaSolution.visible() || konvaSolution.height() === 0) return;
                if (frame.timeDiff > interval) {
                    for (let i = 0; i < countPerInterval; i++) {
                        const bubble = new Konva.Circle({ 
                            x: konvaSolution.x() + Math.random() * konvaSolution.width(),
                            y: konvaSolution.y() + konvaSolution.height() - 5,
                            radius: Math.random() * 3 + 1,
                            fill: 'white', opacity: 0.7, name: 'bubble'
                        });
                        konvaEffectsLayer.add(bubble);
                        new Konva.Tween({node: bubble, duration: Math.random() * 1.5 + 1, y: konvaSolution.y() + 10, opacity: 0, onFinish: () => bubble.destroy()}).play();
                    }
                }
            }, konvaEffectsLayer);
            konvaBubbleAnimation.start();
        }

        function startKonvaSmokeEffect(intensity = "medium") {
            console.log("[KonvaEffect] Starting Smoke with intensity:", intensity);
            if (konvaSmokeAnimation) konvaSmokeAnimation.stop();
            konvaEffectsLayer.find('.smoke').forEach(n => n.destroy());
            let interval = 150; // ms
            let countPerInterval = 1;

            if (intensity === "low") { interval = 250; countPerInterval = 1; }
            else if (intensity === "medium") { interval = 150; countPerInterval = 1; }
            else if (intensity === "high") { interval = 75; countPerInterval = 2; }

            konvaSmokeAnimation = new Konva.Animation(frame => {
                if (!frame) return;
                if (frame.timeDiff > interval) {
                    for (let i = 0; i < countPerInterval; i++) {
                        const smoke = new Konva.Ellipse({ 
                            x: konvaBeaker.x() + konvaBeaker.width() / 2 + (Math.random() - 0.5) * konvaBeaker.width() * 0.6,
                            y: konvaBeaker.y() - 8, radiusX: Math.random() * 10 + 6, radiusY: Math.random() * 6 + 4,
                            fill: 'rgba(180,180,180,0.3)', opacity: 0.5, name: 'smoke'
                        });
                        konvaEffectsLayer.add(smoke);
                        new Konva.Tween({node: smoke, duration: Math.random() * 2.5 + 1.5, y: konvaBeaker.y() - 40, opacity: 0, scaleX: 1.5, scaleY: 1.5, onFinish: () => smoke.destroy()}).play();
                    }
                }
            }, konvaEffectsLayer);
            konvaSmokeAnimation.start();
        }

        function startKonvaPrecipitateEffect(precipitateColorRGBA = "rgba(250, 250, 250, 0.9)") {
            console.log("[KonvaEffect] Starting Precipitate, color:", precipitateColorRGBA);
            if (konvaPrecipitateAnimation) konvaPrecipitateAnimation.stop();
            konvaEffectsLayer.find('.precipitate').forEach(n => n.destroy());
            
            konvaPrecipitateAnimation = new Konva.Animation(frame => {
                 if (!frame || !konvaSolution.visible() || konvaSolution.height() === 0) return;
                if (frame.timeDiff > 50 && Math.random() < 0.4) {
                    const particle = new Konva.Circle({ 
                        x: konvaSolution.x() + Math.random() * konvaSolution.width(),
                        y: konvaSolution.y() + Math.random() * konvaSolution.height() * 0.5,
                        radius: Math.random() * 2 + 0.8, fill: precipitateColorRGBA, name: 'precipitate'
                    });
                    konvaEffectsLayer.add(particle);
                    new Konva.Tween({node: particle, duration: Math.random() * 3 + 2, y: konvaSolution.y() + konvaSolution.height() - particle.radius() - 3, easing: Konva.Easings.EaseIn}).play();
                }
            }, konvaEffectsLayer);
            konvaPrecipitateAnimation.start();
        }

        function visualizeTemperatureChange(effectType) {
            console.log("[KonvaEffect] Visualizing Temperature Change:", effectType);
            konvaEffectsLayer.find('.temp-indicator').forEach(n => n.destroy()); // Clear previous indicators

            let color = 'transparent';
            let opacity = 0;
            let duration = 0;

            if (effectType.includes("exothermic")) {
                color = 'rgba(255, 69, 0, 0.4)'; // Orange-red for exothermic
                opacity = 0.8;
                duration = 2; // seconds
            } else if (effectType.includes("endothermic")) {
                color = 'rgba(0, 191, 255, 0.4)'; // Light blue for endothermic
                opacity = 0.8;
                duration = 2;
            } else {
                return; // No significant temperature change to visualize
            }

            const tempIndicator = new Konva.Rect({
                x: konvaBeaker.x(),
                y: konvaBeaker.y(),
                width: konvaBeaker.width(),
                height: konvaBeaker.height(),
                fill: color,
                opacity: 0, // Start fully transparent
                cornerRadius: konvaBeaker.cornerRadius(),
                name: 'temp-indicator'
            });
            konvaEffectsLayer.add(tempIndicator);

            // Animate fade in and fade out
            new Konva.Tween({
                node: tempIndicator,
                duration: 0.5,
                opacity: opacity,
                easing: Konva.Easings.EaseIn,
                onFinish: () => {
                    new Konva.Tween({
                        node: tempIndicator,
                        duration: duration,
                        opacity: 0,
                        easing: Konva.Easings.EaseOut,
                        onFinish: () => tempIndicator.destroy()
                    }).play();
                }
            }).play();
            konvaEffectsLayer.batchDraw();
        }


        function stopAllKonvaEffects() {
            console.log("[KonvaEffect] Stopping all effects");
            if (!konvaEffectsLayer) { // Add this check
                console.warn("[stopAllKonvaEffects] konvaEffectsLayer is not initialized. Skipping effect stopping.");
                return;
            }
            if (konvaBubbleAnimation) konvaBubbleAnimation.stop();
            if (konvaSmokeAnimation) konvaSmokeAnimation.stop();
            if (konvaPrecipitateAnimation) konvaPrecipitateAnimation.stop();
            konvaEffectsLayer.find('.bubble, .smoke, .precipitate, .temp-indicator').forEach(n => n.destroy());
            konvaEffectsLayer.batchDraw();
        }
        
        function resetBeaker() {
            konvaChemicalsInBeaker = [];
            stopAllKonvaEffects();
            if (konvaSolution) { // Add check for konvaSolution
                konvaSolution.height(0); // Reset height to 0
                konvaSolution.y(konvaBeaker.y() + konvaBeaker.height() - KONVA_SOLUTION_PADDING_BASE); // Move to bottom
                konvaSolution.visible(false); // Make invisible
                konvaSolution.fill('rgba(173, 216, 230, 0.3)'); // Reset to default transparent-ish blue
            }
            if (konvaLayer) konvaLayer.batchDraw(); // Add check for konvaLayer
            document.getElementById('responseContainer').textContent = "Cốc đã được làm sạch.";
            showToast("Cốc đã được làm sạch.");

            // Clear current experiment state if not already cleared by loadExperimentIntoBeaker
            if (currentExperimentId !== null || currentExperimentData !== null) {
                currentExperimentId = null;
                currentExperimentData = null;
                experimentNameInput.value = '';
                showToast("Đã xóa trạng thái thí nghiệm hiện tại.");
            }
        }

        document.getElementById('resetBeakerButton').addEventListener('click', resetBeaker);
        
        document.getElementById('sendPromptButtonLab').addEventListener('click', () => {
            const promptText = document.getElementById('promptInput').value;
            callGeminiAPI(promptText); 
        });

        // NEW: Event listener for saving experiment
        saveExperimentButton.addEventListener('click', saveExperiment);


        function fitKonvaStageToParent() {
            const container = document.getElementById('konva-outer-container');
            if (!container || !konvaStage) return;
            let containerWidth = container.offsetWidth - 16; 
            if (containerWidth <=0) containerWidth = KONVA_INITIAL_STAGE_WIDTH; 
            const scale = containerWidth / KONVA_INITIAL_STAGE_WIDTH;
            konvaStage.width(containerWidth);
            konvaStage.height(KONVA_INITIAL_STAGE_HEIGHT * scale); 
            if (konvaBeaker) {
                konvaBeaker.width(getKonvaResponsiveSize(KONVA_BEAKER_BASE_SIZE.width, KONVA_INITIAL_STAGE_WIDTH, konvaStage.width()).width);
                konvaBeaker.height(getKonvaResponsiveSize(KONVA_BEAKER_BASE_SIZE.height, KONVA_INITIAL_STAGE_WIDTH, konvaStage.width()).height);
                konvaBeaker.x(getKonvaResponsiveValue(KONVA_BEAKER_BASE_X, KONVA_INITIAL_STAGE_WIDTH, konvaStage.width()));
                konvaBeaker.y(getKonvaResponsiveValue(KONVA_BEAKER_BASE_Y, KONVA_INITIAL_STAGE_HEIGHT, konvaStage.height())); 
                updateKonvaBeakerLabelPosition();
            }
            if (konvaSolution) {
                updateKonvaSolutionVisualState();
            }
            // Add check for konvaLayer before using find()
            if (konvaLayer) {
                konvaLayer.find('.dynamic-chemical').forEach(group => {
                    const chemicalSize = getKonvaResponsiveSize(60, KONVA_INITIAL_STAGE_WIDTH, konvaStage.width());
                    group.findOne('Rect').width(chemicalSize.width).height(chemicalSize.height * 1.2);
                    group.findOne('Text').fontSize(getKonvaResponsiveValue(10, KONVA_INITIAL_STAGE_WIDTH, konvaStage.width())).width(chemicalSize.width);
                });
            }
            konvaStage.batchDraw();
            if (konvaEffectsLayer) konvaEffectsLayer.batchDraw(); // Add check for konvaEffectsLayer
        }

    </script>
</body>
</html>
